<div class="main-content">
  <div class="admin-dashboard">
    <!-- Header Premium -->
    <div class="dashboard-header">
      <div class="header-content">
        <div class="header-title">
          <div class="title-icon">üßæ</div>
          <div>
            <h1>QU·∫¢N L√ù H√ìA ƒê∆†N</h1>
            <p>Theo d√µi v√† qu·∫£n l√Ω h√≥a ƒë∆°n karaoke</p>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn-primary" id="createHoaDonBtn">
            <i class="fas fa-plus"></i>
            <span>T·∫°o h√≥a ƒë∆°n</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Search and Filter Bar -->
    <div class="search-filter-bar">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm h√≥a ƒë∆°n...">
        <button class="search-btn" id="searchBtn">T√¨m ki·∫øm</button>
      </div>
      <div class="filter-controls">
        <select class="filter-select" id="statusFilter">
          <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
          <option value="Ch∆∞a thanh to√°n">Ch∆∞a thanh to√°n</option>
          <option value="ƒê√£ thanh to√°n">ƒê√£ thanh to√°n</option>
          <option value="ƒê√£ h·ªßy">ƒê√£ h·ªßy</option>
        </select>
        <input type="date" class="filter-select" id="dateFromFilter" placeholder="T·ª´ ng√†y">
        <input type="date" class="filter-select" id="dateToFilter" placeholder="ƒê·∫øn ng√†y">
        <select class="filter-select" id="sortFilter">
          <option value="newest">M·ªõi nh·∫•t</option>
          <option value="oldest">C≈© nh·∫•t</option>
          <option value="highest">Cao nh·∫•t</option>
          <option value="lowest">Th·∫•p nh·∫•t</option>
        </select>
        <button class="clear-filters" id="clearFiltersBtn">
          <i class="fas fa-times"></i>
          X√≥a l·ªçc
        </button>
      </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-overview">
      <div class="stat-card">
        <div class="stat-icon total">
          <i class="fas fa-receipt"></i>
        </div>
        <div class="stat-info">
          <h3 id="statTotal">0</h3>
          <p>T·ªïng h√≥a ƒë∆°n</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon active">
          <i class="fas fa-money-bill-wave"></i>
        </div>
        <div class="stat-info">
          <h3 id="statRevenue">0</h3>
          <p>Doanh thu h√¥m nay</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon reception">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stat-info">
          <h3 id="statPending">0</h3>
          <p>Ch·ªù thanh to√°n</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon service">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stat-info">
          <h3 id="statPaid">0</h3>
          <p>ƒê√£ thanh to√°n</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon technical">
          <i class="fas fa-times-circle"></i>
        </div>
        <div class="stat-info">
          <h3 id="statCancelled">0</h3>
          <p>ƒê√£ h·ªßy</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon manager">
          <i class="fas fa-calendar-day"></i>
        </div>
        <div class="stat-info">
          <h3 id="statToday">0</h3>
          <p>H√≥a ƒë∆°n h√¥m nay</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon security">
          <i class="fas fa-calendar-week"></i>
        </div>
        <div class="stat-info">
          <h3 id="statWeek">0</h3>
          <p>Tu·∫ßn n√†y</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon fulltime">
          <i class="fas fa-calendar-month"></i>
        </div>
        <div class="stat-info">
          <h3 id="statMonth">0</h3>
          <p>Th√°ng n√†y</p>
        </div>
      </div>
    </div>

    <!-- HoaDon Grid -->
    <div class="employees-grid" id="hoaDonGrid">
      {{#each hoadons}}
      <div class="employee-card" 
           data-id="{{this._id}}" 
           data-mahd="{{this.MaHoaDon}}"
           data-madp="{{this.MaDatPhong}}"
           data-tongtien="{{this.TongTien}}" 
           data-status="{{this.TrangThai}}" 
           data-date="{{formatDate this.createdAt}}">
        <div class="employee-image">
          <div class="employee-avatar-placeholder bill">
            <i class="fas fa-receipt"></i>
          </div>
          <div class="employee-overlay">
            <div class="employee-actions">
              {{!-- {{#unless (or (eq this.TrangThai "ƒê√£ thanh to√°n") (eq this.TrangThai "ƒê√£ h·ªßy"))}} --}}
              <button class="btn-edit" data-mahd="{{this.MaHoaDon}}">
                <i class="fas fa-edit"></i>
              </button>
              {{!-- {{/unless}} --}}
              <button class="btn-delete" data-id="{{this._id}}" data-mahd="{{this.MaHoaDon}}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <div class="employee-badge {{this.TrangThai}}">
            {{this.TrangThai}}
          </div>
          <div class="employee-status {{#if (eq this.TrangThai 'ƒê√£ thanh to√°n')}}active{{else if (eq this.TrangThai 'Ch∆∞a thanh to√°n')}}onleave{{else}}inactive{{/if}}">
            {{formatNumber this.TongTien}} VND
          </div>
        </div>

        <div class="employee-content">
          <h3 class="employee-name">{{this.MaHoaDon}}</h3>
          <p class="employee-code">ƒê·∫∑t ph√≤ng: 
            {{#if this.MaDatPhong}}
                {{this.MaDatPhong}}
            {{else}}
                G·ªçi tr·ª±c ti·∫øp
            {{/if}}
          </p>

          <div class="employee-details">
            <div class="detail-item">
              <i class="fas fa-calendar-alt"></i>
              <span>{{formatDate this.createdAt}}</span>
            </div>
            <div class="detail-item">
              <i class="fas fa-money-bill-wave"></i>
              <span>{{formatNumber this.TongTien}} VND</span>
            </div>
            <div class="detail-item">
              <i class="fas fa-user"></i>
              <span>KH: {{this.KH.TenKH}}</span>
            </div>
            <div class="detail-item">
              <i class="fas fa-door-open"></i>
              <span>Ph√≤ng: {{this.MaPhong}}</span>
            </div>
            {{#if this.ThoiGianBatDau}}
            <div class="detail-item">
              <i class="fas fa-play-circle"></i>
              <span>B·∫Øt ƒë·∫ßu: {{formatTime this.ThoiGianBatDau}}</span>
            </div>
            {{/if}}
            {{#if this.ThoiGianKetThuc}}
            <div class="detail-item">
              <i class="fas fa-stop-circle"></i>
              <span>K·∫øt th√∫c: {{formatTime this.ThoiGianKetThuc}}</span>
            </div>
            {{else}}
            <div class="detail-item">
              <i class="fas fa-stop-circle"></i>
              <span class="highlight">K·∫øt th√∫c: ƒêang s·ª≠ d·ª•ng</span>
            </div>
            {{/if}}
          </div>

          <!-- FOOTER V·ªöI 2 N√öT -->
          <div class="employee-footer">
            <button class="btn-detail" data-mahd="{{this.MaHoaDon}}">
              <i class="fas fa-eye"></i>
              Xem chi ti·∫øt
            </button>
            {{#if (eq this.TrangThai "Ch∆∞a thanh to√°n")}}
            <button class="btn-pay" data-mahd="{{this.MaHoaDon}}">
              <i class="fas fa-credit-card"></i>
              Thanh to√°n
            </button>
            {{else}}
            <button class="btn-print" data-mahd="{{this.MaHoaDon}}">
              <i class="fas fa-print"></i>
              In h√≥a ƒë∆°n
            </button>
            {{/if}}
          </div>
        </div>
      </div>
      {{/each}}
    </div>

    <!-- Empty State -->
    <div class="empty-state" id="emptyState" style="{{#if hoadons.length}}display: none;{{else}}display: block;{{/if}}">
      <div class="empty-icon">üßæ</div>
      <h3>Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n</h3>
      <p>Th·ª≠ thay ƒë·ªïi b·ªô l·ªçc ho·∫∑c t·∫°o h√≥a ƒë∆°n m·ªõi</p>
      <button class="btn-primary" id="createEmptyBtn">
        <i class="fas fa-plus"></i>
        T·∫°o h√≥a ƒë∆°n ƒë·∫ßu ti√™n
      </button>
    </div>
  </div>

  <!-- HoaDon Modal -->
  <div class="modal-overlay" id="hoaDonModal" style="display: none;">
    <div class="modal-container large">
      <div class="modal-header">
        <h2 id="modalTitle">T·∫°o h√≥a ƒë∆°n m·ªõi</h2>
        <button class="modal-close" id="closeHoaDonModal">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <form id="hoaDonForm">
          <input type="hidden" id="hoaDonId">
          <input type="hidden" id="hoaDonMaHD">

          <!-- Ph·∫ßn 1: Th√¥ng tin kh√°ch h√†ng -->
          <div class="form-section">
            <input type="hidden" id="maKH">
            <h3>Th√¥ng tin kh√°ch h√†ng</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="sdtKH">S·ªë ƒëi·ªán tho·∫°i *</label>
                <input type="text" id="sdtKH" required placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
              </div>
              
              <div class="form-group d-none">
                <label for="tenKH">H·ªç t√™n *</label>
                <input type="text" id="tenKH" required placeholder="Nh·∫≠p h·ªç t√™n kh√°ch h√†ng">
              </div>
              
              <div class="form-group d-none full-width">
                <label for="emailKH">Email</label>
                <input type="email" id="emailKH" placeholder="Nh·∫≠p email (kh√¥ng b·∫Øt bu·ªôc)">
              </div>
            </div>
          </div>

          <!-- Ph·∫ßn 2: Th√¥ng tin ph√≤ng -->
          <div class="form-section">
            <h3>Th√¥ng tin ph√≤ng</h3>
            <div class="form-grid">
              <div class="form-group">
                <label for="phongSelect">Ch·ªçn ph√≤ng *</label>
                <select id="phongSelect" required>
                  <option value="">Ch·ªçn ph√≤ng</option>
                  <!-- S·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
                </select>
              </div>

              <div class="form-group">
                <label for="thoiGianBatDau">Th·ªùi gian b·∫Øt ƒë·∫ßu *</label>
                <input type="datetime-local" id="thoiGianBatDau" required>
              </div>
            </div>

            <!-- Hi·ªÉn th·ªã gi√° ph√≤ng -->
            <div class="price-section">
              <div class="price-row">
                <span>Ti·ªÅn ph√≤ng:</span>
                <span id="giaPhongDisplay">0 VND</span>
              </div>
            </div>
          </div>

          <!-- Ph·∫ßn 3: D·ªãch v·ª• ƒëi k√®m -->
          <div class="form-section">
            <h3>D·ªãch v·ª• ƒëi k√®m</h3>
            <div class="service-controls">
              <div class="service-search">
                <input type="text" id="serviceSearch" placeholder="T√¨m ki·∫øm d·ªãch v·ª•">
                <i class="fas fa-search"></i>
              </div>
              <select id="matHangSelect">
                <option value="">Ch·ªçn m·∫∑t h√†ng</option>
                <!-- S·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
              </select>
              <input type="number" id="soLuong" placeholder="S·ªë l∆∞·ª£ng" min="1" value="1" max="100">
              <button type="button" class="btn-secondary" id="addServiceBtn">
                <i class="fas fa-plus"></i> Th√™m
              </button>
            </div>

            <!-- Danh s√°ch d·ªãch v·ª• ƒë√£ th√™m -->
            <div class="services-list-container">
              <h4>D·ªãch v·ª• ƒë√£ th√™m:</h4>
              <div class="services-list" id="servicesList">
                <div class="no-services">Ch∆∞a c√≥ d·ªãch v·ª• n√†o ƒë∆∞·ª£c th√™m</div>
              </div>
            </div>

            <!-- T·ªïng ti·ªÅn d·ªãch v·ª• -->
            <div class="price-section">
              <div class="price-row">
                <span>Ti·ªÅn d·ªãch v·ª•:</span>
                <span id="tienDichVuDisplay">0 VND</span>
              </div>
            </div>
          </div>

          <!-- T·ªïng ti·ªÅn -->
          <div class="total-section">
            <div class="total-row grand-total">
              <span><strong>T·ªïng c·ªông:</strong></span>
              <span id="tongTienDisplay"><strong>0 VND</strong></span>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" type="button" id="cancelHoaDonBtn">H·ªßy</button>
        <button class="btn-primary" type="button" id="saveHoaDonBtn">L∆∞u h√≥a ƒë∆°n</button>
      </div>
    </div>
  </div>

  <!-- Chi ti·∫øt h√≥a ƒë∆°n Modal -->
  <div class="modal-overlay" id="detailModal" style="display: none;">
    <div class="modal-container invoice-modal">
      <div class="modal-header invoice-company-header">
        <div class="header-top-row">
          <div class="company-logo">
            <div class="logo-placeholder">
              <i class="fas fa-microphone-alt"></i>
            </div>
            <div class="company-info">
              <h1>KARAOKE NNICE</h1>
              <p>113 Phan X√≠ch Long, Ph∆∞·ªùng 2, Qu·∫≠n Ph√∫ Nhu·∫≠n,<br> TP. H·ªì Ch√≠ Minh, Vi·ªát Nam ‚Ä¢ (028) 35 170 046</p>
            </div>
          </div>
          <div class="header-actions" id="headerActions">
            <!-- N√∫t h√†nh ƒë·ªông s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·∫±ng JS -->
          </div>
        </div>
        
        <div class="header-title-row">
          <h2>CHI TI·∫æT H√ìA ƒê∆†N</h2>
        </div>
        
        <div class="header-meta-row">
          <div class="meta-item">
            <span class="label">Ng√†y xu·∫•t:</span>
            <span class="value" id="modal-invoice-date"></span>
          </div>
          <div class="meta-item">
            <span class="label">M√£ h√≥a ƒë∆°n:</span>
            <span class="value" id="modal-invoice-number"></span>
          </div>
          <div class="meta-item">
            <span class="label">Tr·∫°ng th√°i:</span>
            <span class="value status-badge" id="modal-invoice-status"></span>
          </div>
        </div>
      </div>
      
      <div class="modal-body" id="detailContent">
        <!-- N·ªôi dung chi ti·∫øt s·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JS -->
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// ===== BI·∫æN TO√ÄN C·ª§C =====
let allHoaDons = [];
let filteredHoaDons = [];
let allPhongs = [];
let allMatHangs = [];
let filteredMatHangs = [];
let selectedServices = [];
let currentRoomPrice = 0;
let thoiGianBatDauComeBack;

// ===== KH·ªûI T·∫†O KHI DOM READY =====
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    initializeEventListeners();
    loadInitialData();
    calculateStatistics();
}

// ===== GET HOA DON DATA FROM API =====
async function getHoaDonData(maHoaDon) {
    try {
        console.log('M√£ Ho√° ƒê∆°n: ', maHoaDon);

        const response = await fetch(`/api/hoadon/edit/${maHoaDon}`);
        const result = await response.json();

        console.log(result);
        return result;
      
    } catch (error) {
        console.error('‚ùå L·ªói khi l·∫•y d·ªØ li·ªáu h√≥a ƒë∆°n:', error);
        showError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu h√≥a ƒë∆°n: ' + error.message);
        return null;
    }
}

function initializeEventListeners() {
  // Header actions - T·∫†O M·ªöI (kh√¥ng truy·ªÅn tham s·ªë)
    document.getElementById('createHoaDonBtn').addEventListener('click', function() {
        openHoaDonModal(); // Kh√¥ng truy·ªÅn tham s·ªë
    });
    
    document.getElementById('createEmptyBtn').addEventListener('click', function() {
        openHoaDonModal(); // Kh√¥ng truy·ªÅn tham s·ªë
    });

    // Search and filter
    document.getElementById('searchBtn').addEventListener('click', filterHoaDon);
    document.getElementById('searchInput').addEventListener('keyup', filterHoaDon);
    document.getElementById('statusFilter').addEventListener('change', filterHoaDon);
    document.getElementById('dateFromFilter').addEventListener('change', filterHoaDon);
    document.getElementById('dateToFilter').addEventListener('change', filterHoaDon);
    document.getElementById('sortFilter').addEventListener('change', filterHoaDon);
    document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);

    // Modal actions
    document.getElementById('closeHoaDonModal').addEventListener('click', closeHoaDonModal);
    document.getElementById('cancelHoaDonBtn').addEventListener('click', closeHoaDonModal);
    document.getElementById('saveHoaDonBtn').addEventListener('click', saveHoaDon);

    // Check customer's phone
    document.getElementById('sdtKH').addEventListener('keyup', checkExistPhoneCustomer)

    // Service controls
    document.getElementById('addServiceBtn').addEventListener('click', addService);
    document.getElementById('serviceSearch').addEventListener('keyup', filterServices);
    document.getElementById('phongSelect').addEventListener('change', function() {
        {{!-- updateRoomPrice(); --}}
        resetRoomForm(); // h√†m m·ªõi mu·ªën th√™m
    });
    document.getElementById('thoiGianBatDau').addEventListener('change', updateRoomPrice);

    // Delegated events for dynamic content
    document.addEventListener('click', function(e) {
        // Edit buttons
        if (e.target.closest('.btn-edit')) {
            const mahd = e.target.closest('.btn-edit').getAttribute('data-mahd');
            getHoaDonData(mahd).then(hoaDonData => {
                openHoaDonModal(hoaDonData);
            });
        }
        // Detail buttons
        if (e.target.closest('.btn-detail')) {
            const mahd = e.target.closest('.btn-detail').getAttribute('data-mahd');
            viewHoaDonDetail(mahd);
        }
        // Pay buttons
        if (e.target.closest('.btn-pay')) {
            const mahd = e.target.closest('.btn-pay').getAttribute('data-mahd');
            thanhToanHoaDon(mahd);
        }
        // Print buttons
        if (e.target.closest('.btn-print')) {
            const mahd = e.target.closest('.btn-print').getAttribute('data-mahd');
            printHoaDon(mahd);
        }
        // Remove service buttons
        if (e.target.closest('.btn-delete-service')) {
            const index = e.target.closest('.btn-delete-service').getAttribute('data-index');
            removeService(parseInt(index));
        }

        // Delete buttons
        if (e.target.closest('.btn-delete')) {
            const btn = e.target.closest('.btn-delete');
            const id = btn.getAttribute('data-id');
            const mahd = btn.getAttribute('data-mahd');
            deleteHoaDon(id, mahd);
        }
    });
}

function loadInitialData() {
    allHoaDons = Array.from(document.querySelectorAll('.employee-card'));
    filteredHoaDons = [...allHoaDons];
}

// ===== STATISTICS CALCULATION =====
function calculateStatistics() {
    const hoaDons = allHoaDons;
    
    const totalHoaDons = hoaDons.length;
    const today = new Date().toDateString();
    const todayRevenue = hoaDons
        .filter(hd => new Date(hd.getAttribute('data-date')).toDateString() === today && 
                      hd.getAttribute('data-status') === 'ƒê√£ thanh to√°n')
        .reduce((sum, hd) => sum + parseFloat(hd.getAttribute('data-tongtien')), 0);
    
    const countPending = hoaDons.filter(hd => hd.getAttribute('data-status') === 'Ch∆∞a thanh to√°n').length;
    const countPaid = hoaDons.filter(hd => hd.getAttribute('data-status') === 'ƒê√£ thanh to√°n').length;
    const countCancelled = hoaDons.filter(hd => hd.getAttribute('data-status') === 'ƒê√£ h·ªßy').length;
    const countToday = hoaDons.filter(hd => 
        new Date(hd.getAttribute('data-date')).toDateString() === today
    ).length;

    updateStatCard('#statTotal', totalHoaDons);
    updateStatCard('#statRevenue', formatNumber(todayRevenue));
    updateStatCard('#statPending', countPending);
    updateStatCard('#statPaid', countPaid);
    updateStatCard('#statCancelled', countCancelled);
    updateStatCard('#statToday', countToday);
    updateStatCard('#statWeek', Math.floor(countToday * 1.5));
    updateStatCard('#statMonth', Math.floor(countToday * 6));
}

function updateStatCard(selector, value) {
    const element = document.querySelector(selector);
    if (element) {
        element.textContent = value;
    }
}

// ===== FORMAT FUNCTIONS =====
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN');
}

function formatTime(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
}

function formatNumber(amount) {
    if (typeof amount === 'string') {
        amount = parseFloat(amount) || 0;
    }
    return new Intl.NumberFormat('vi-VN').format(amount);
}

// ===== HOA DON MODAL MANAGEMENT =====
async function openHoaDonModal(hoaDonData = null) {
    console.log('üìù Opening modal with data:', hoaDonData); // Debug log
    
    // ƒê·∫£m b·∫£o hoaDonData l√† null khi t·∫°o m·ªõi
    const isEditMode = hoaDonData !== null && hoaDonData !== undefined;
    
    document.getElementById('modalTitle').textContent = isEditMode ? 'Ch·ªânh s·ª≠a h√≥a ƒë∆°n' : 'T·∫°o h√≥a ƒë∆°n m·ªõi';
    document.getElementById('hoaDonModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';

    await loadAllData();

    if (isEditMode) {
        populateHoaDonEdit(hoaDonData);
    } else {
        resetHoaDonForm();
    }
}

function closeHoaDonModal() {
    document.getElementById('hoaDonModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    resetHoaDonForm();
}

// ===== LOAD DATA FROM APIs =====
async function loadAllData() {
    try {
        const [phongResponse, mathangResponse] = await Promise.all([
            fetch('/api/hoadon/phongtrong'),
            fetch('/api/hoadon/mathang')
        ]);

        const phongResult = await phongResponse.json();
        const mathangResult = await mathangResponse.json();

        console.log(phongResult);
        console.log(mathangResult);

        if (phongResult.success && mathangResult.success) {
            allPhongs = phongResult.data;
            allMatHangs = mathangResult.data;
            filteredMatHangs = [...allMatHangs];
            
            populatePhongSelect();
            populateMatHangSelect();
        } else {
            throw new Error(phongResult.message || mathangResult.message);
        }
    } catch (error) {
        console.error('L·ªói khi load d·ªØ li·ªáu:', error);
        showError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ' + error.message);
    }
}

function populatePhongSelect() {
    const phongSelect = document.getElementById('phongSelect');
    phongSelect.innerHTML = '<option value="">Ch·ªçn ph√≤ng</option>';
    
    allPhongs.forEach(phong => {
        const option = document.createElement('option');
        option.value = phong.MaPhong;
        option.textContent = phong.TenPhong;
        
        let giaPhong = 0;
        if (phong.BangGia && phong.BangGia.length > 0) {
            giaPhong = phong.BangGia[0].GiaTien || 0;
        }
        
        option.setAttribute('data-gia', giaPhong);
        phongSelect.appendChild(option);
    });
}

function populateMatHangSelect() {
    const matHangSelect = document.getElementById('matHangSelect');
    matHangSelect.innerHTML = '<option value="">Ch·ªçn m·∫∑t h√†ng</option>';
    
    filteredMatHangs.forEach(mathang => {
        const option = document.createElement('option');
        option.value = mathang.MaHang;
        option.textContent = `${mathang.TenHang} - ${formatNumber(mathang.DonGia)}/${mathang.DonViTinh} (T·ªìn: ${mathang.SoLuongTon})`;
        option.setAttribute('data-dongia', mathang.DonGia);
        option.setAttribute('data-tenhang', mathang.TenHang);
        option.setAttribute('data-dvt', mathang.DonViTinh);
        option.setAttribute('data-slt', mathang.SoLuongTon);
        matHangSelect.appendChild(option);
    });
}

// ===== SERVICE MANAGEMENT =====
let searchTimeout;
function filterServices() {
    const searchTerm = document.getElementById('serviceSearch').value.trim();
    
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
        if (searchTerm.length === 0) {
            filteredMatHangs = [...allMatHangs];
            populateMatHangSelect();
            return;
        }
        
        try {
            const response = await fetch(`/api/mathang/tonkho?search=${encodeURIComponent(searchTerm)}`);
            const result = await response.json();
            
            if (result.success) {
                filteredMatHangs = result.data;
                populateMatHangSelect();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('L·ªói khi t√¨m ki·∫øm m·∫∑t h√†ng:', error);
            filteredMatHangs = allMatHangs.filter(mathang => 
                mathang.TenHang.toLowerCase().includes(searchTerm.toLowerCase())
            );
            populateMatHangSelect();
        }
    }, 300);
}

function addService() {
    const matHangSelect = document.getElementById('matHangSelect');
    const soLuongInput = document.getElementById('soLuong');
    
    if (!matHangSelect.value) {
        showError('Vui l√≤ng ch·ªçn m·∫∑t h√†ng');
        return;
    }
    
    const soLuong = parseInt(soLuongInput.value);
    if (!soLuong || soLuong < 1) {
        showError('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá');
        return;
    }

    const selectedOption = matHangSelect.options[matHangSelect.selectedIndex];
    const soLuongTon = parseInt(selectedOption.getAttribute('data-slt'));

    if (soLuong > soLuongTon) {
        showError(`S·ªë l∆∞·ª£ng t·ªìn kh√¥ng ƒë·ªß. Ch·ªâ c√≤n ${soLuongTon} ${selectedOption.getAttribute('data-dvt')}`);
        return;
    }

    const service = {
        MaHang: matHangSelect.value,
        TenHang: selectedOption.getAttribute('data-tenhang'),
        SoLuong: soLuong,
        DonGia: parseFloat(selectedOption.getAttribute('data-dongia')),
        DonViTinh: selectedOption.getAttribute('data-dvt'),
        ThanhTien: soLuong * parseFloat(selectedOption.getAttribute('data-dongia')),
        SoLuongTon: soLuongTon
    };

    const existingIndex = selectedServices.findIndex(s => s.MaHang === service.MaHang);
    if (existingIndex >= 0) {
        const newQuantity = selectedServices[existingIndex].SoLuong + soLuong;
        if (newQuantity > service.SoLuongTon) {
            showError(`T·ªïng s·ªë l∆∞·ª£ng v∆∞·ª£t qu√° t·ªìn kho. Ch·ªâ c√≤n ${service.SoLuongTon} ${service.DonViTinh}`);
            return;
        }
        selectedServices[existingIndex].SoLuong = newQuantity;
        selectedServices[existingIndex].ThanhTien = newQuantity * selectedServices[existingIndex].DonGia;
    } else {
        selectedServices.push(service);
    }

    renderServicesList();
    calculateTotal();
    
    soLuongInput.value = 1;
}

function removeService(index) {
    selectedServices.splice(index, 1);
    renderServicesList();
    calculateTotal();
}

function updateServiceQuantity(index, change) {
    const newQuantity = selectedServices[index].SoLuong + change;
    
    if (newQuantity < 1) {
        removeService(index);
        return;
    }

    const service = selectedServices[index];
    if (newQuantity > service.SoLuongTon) {
        showError(`S·ªë l∆∞·ª£ng t·ªìn kh√¥ng ƒë·ªß. Ch·ªâ c√≤n ${service.SoLuongTon} ${service.DonViTinh}`);
        return;
    }

    service.SoLuong = newQuantity;
    service.ThanhTien = newQuantity * service.DonGia;
    renderServicesList();
    calculateTotal();
}

function renderServicesList() {
    const servicesList = document.getElementById('servicesList');
    
    if (selectedServices.length === 0) {
        servicesList.innerHTML = '<div class="no-services">Ch∆∞a c√≥ d·ªãch v·ª• n√†o ƒë∆∞·ª£c th√™m</div>';
        return;
    }

    servicesList.innerHTML = '';
    selectedServices.forEach((service, index) => {
          // B·ªè qua d·ªãch v·ª• "Thu√™ ph√≤ng"
        if (service.LoaiDichVu === 'Thu√™ ph√≤ng') {
            return;
        }

        const serviceElement = document.createElement('div');
        serviceElement.className = 'service-item-row';
        serviceElement.innerHTML = `
            <div class="service-info">
                <span class="service-name">${service.TenHang}</span>
                <span class="service-details">${formatNumber(service.DonGia)}/${service.DonViTinh}</span>
            </div>
            <div class="service-quantity-controls">
                <button type="button" class="qty-btn" onclick="updateServiceQuantity(${index}, -1)">-</button>
                <span class="service-quantity">${service.SoLuong}</span>
                <button type="button" class="qty-btn" onclick="updateServiceQuantity(${index}, 1)">+</button>
            </div>
            <div class="service-actions">
                <span class="service-total">${formatNumber(service.ThanhTien)} VND</span>
                <button type="button" class="btn-delete-service" data-index="${index}">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
      servicesList.appendChild(serviceElement);
    });
}

function calculateTotal() {
    const serviceTotal = selectedServices.filter(service => service.LoaiDichVu !== 'Thu√™ ph√≤ng').reduce((sum, service) => sum + service.ThanhTien, 0);
    const total = currentRoomPrice + serviceTotal;

    document.getElementById('tienDichVuDisplay').textContent = formatNumber(serviceTotal) + ' VND';
    document.getElementById('tongTienDisplay').textContent = formatNumber(total) + ' VND';
}

function resetHoaDonForm() {
    document.getElementById('hoaDonForm').reset();
    document.getElementById('hoaDonId').value = '';
    document.getElementById('hoaDonMaHD').value = '';
    selectedServices = [];
    currentRoomPrice = 0;
    document.getElementById('giaPhongDisplay').textContent = '0 VND';
    document.getElementById('tienDichVuDisplay').textContent = '0 VND';
    document.getElementById('tongTienDisplay').textContent = '0 VND';

    // ·∫®n 2 field th√¥ng tin kh√°ch h√†ng
    document.getElementById('tenKH').closest('.form-group').classList.add('d-none')
    document.getElementById('emailKH').closest('.form-group').classList.add('d-none')

    renderServicesList();
}

// ===== SAVE HOA DON =====
async function saveHoaDon() {
    const maKH = document.getElementById('maKH').value;
    const tenKH = document.getElementById('tenKH').value;
    const sdtKH = document.getElementById('sdtKH').value;
    const emailKH = document.getElementById('emailKH').value;
    const phongSelect = document.getElementById('phongSelect').value;
    const thoiGianBatDau = document.getElementById('thoiGianBatDau').value;
    const maHoaDon = document.getElementById('hoaDonMaHD').value;
    const isEditMode = !!maHoaDon;


    if (!tenKH || !sdtKH || !phongSelect || !thoiGianBatDau) {
        showError('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
        return;
    }

    if (selectedServices.length === 0 && currentRoomPrice === 0) {
        showError('H√≥a ƒë∆°n ph·∫£i c√≥ √≠t nh·∫•t m·ªôt d·ªãch v·ª• ho·∫∑c ti·ªÅn ph√≤ng');
        return;
    }

    console.log(selectedServices);

    const formData = {
        maHoaDon,
        maKH,
        tenKH,
        sdtKH,
        emailKH,
        maPhong: phongSelect,
        thoiGianBatDau,
        tienPhong: currentRoomPrice,
        dichVu: selectedServices.filter(service => service.LoaiDichVu !== 'Thu√™ ph√≤ng').map(service => ({
            MaHang: service.MaHang,
            TenHang: service.TenHang,
            LoaiDichVu: service.LoaiDichVu,
            SoLuong: service.SoLuong,
            DonGia: service.DonGia,
            DonViTinh: service.DonViTinh,
            ThanhTien: service.ThanhTien
        })),
        tongTien: currentRoomPrice + selectedServices.filter(service => service.LoaiDichVu !== 'Thu√™ ph√≤ng').reduce((sum, service) => sum + service.ThanhTien, 0)
    };

    if (isEditMode) {
        formData.maHoaDon = maHoaDon;
    }

    console.log(formData);
    console.log(isEditMode, maHoaDon);

    try {
        Swal.fire({
            title: 'ƒêang l∆∞u h√≥a ƒë∆°n...',
            text: 'Vui l√≤ng ch·ªù trong gi√¢y l√°t',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        const endpoint = isEditMode ? `/api/hoadon/edit/${maHoaDon}` : '/api/hoadon';
        const method = isEditMode ? 'PUT' : 'POST';

        const response = await fetch(endpoint, {
            method: method,
            headers: { 
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        const result = await response.json();
        
        if (!response.ok) {
            throw new Error(result.error || result.message || `L·ªói ${response.status}: ${response.statusText}`);
        }

        let successMessage = result.message || 'H√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!';

        if (result.data) {
            // Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt n·∫øu c√≥
            const { MaHoaDon, TongTien, TrangThai } = result.data;
            successMessage += `\nM√£ Hƒê: ${MaHoaDon}\nT·ªïng ti·ªÅn: ${formatNumber(TongTien)} VND\nTr·∫°ng th√°i: ${TrangThai}`;
        }

        Swal.fire({
            icon: 'success',
            title: 'Th√†nh c√¥ng!',
            text: result.message || 'H√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!',
            timer: 1500,
            showConfirmButton: false
        });

        setTimeout(() => {
            location.reload();
        }, 1500);

    } catch (error) {
        console.error('‚ùå L·ªói khi l∆∞u h√≥a ƒë∆°n:', error);
        Swal.fire({
            icon: 'error',
            title: 'L·ªói!',
            text: error.message || 'Kh√¥ng th·ªÉ l∆∞u h√≥a ƒë∆°n',
            confirmButtonColor: '#667eea'
        });
    }
}

// ===== FILTER & SEARCH =====
function filterHoaDon() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const dateFrom = document.getElementById('dateFromFilter').value;
    const dateTo = document.getElementById('dateToFilter').value;
    const sortFilter = document.getElementById('sortFilter').value;

    filteredHoaDons = allHoaDons.filter(card => {
        const maHD = card.getAttribute('data-mahd').toLowerCase();
        const maDP = card.getAttribute('data-madp').toLowerCase();
        const status = card.getAttribute('data-status');
        const date = card.getAttribute('data-date');

        const matchesSearch = !searchTerm || 
            maHD.includes(searchTerm) || 
            maDP.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;
        const matchesDate = (!dateFrom || date >= dateFrom) && 
                           (!dateTo || date <= dateTo);

        const shouldShow = matchesSearch && matchesStatus && matchesDate;
        card.style.display = shouldShow ? 'block' : 'none';
        return shouldShow;
    });

    sortHoaDons(sortFilter);
    calculateFilteredStatistics();
    toggleEmptyState(filteredHoaDons.length === 0);
}

function sortHoaDons(sortType) {
    const container = document.getElementById('hoaDonGrid');
    const cards = Array.from(container.querySelectorAll('.employee-card'));

    cards.sort((a, b) => {
        switch (sortType) {
            case 'newest':
                return new Date(b.getAttribute('data-date')) - new Date(a.getAttribute('data-date'));
            case 'oldest':
                return new Date(a.getAttribute('data-date')) - new Date(b.getAttribute('data-date'));
            case 'highest':
                return parseFloat(b.getAttribute('data-tongtien')) - parseFloat(a.getAttribute('data-tongtien'));
            case 'lowest':
                return parseFloat(a.getAttribute('data-tongtien')) - parseFloat(b.getAttribute('data-tongtien'));
            default:
                return 0;
        }
    });

    cards.forEach(card => container.appendChild(card));
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('dateFromFilter').value = '';
    document.getElementById('dateToFilter').value = '';
    document.getElementById('sortFilter').value = 'newest';

    filterHoaDon();
}

function toggleEmptyState(show) {
    const emptyState = document.getElementById('emptyState');
    const grid = document.getElementById('hoaDonGrid');

    if (!emptyState || !grid) return;

    if (show) {
        grid.style.display = 'none';
        emptyState.style.display = 'block';
    } else {
        grid.style.display = 'grid';
        emptyState.style.display = 'none';
    }
}

function calculateFilteredStatistics() {
    // C·∫≠p nh·∫≠t th·ªëng k√™ d·ª±a tr√™n filteredHoaDons n·∫øu c·∫ßn
}

// ===== UTILITY FUNCTIONS =====
function showError(message) {
    Swal.fire({
        icon: 'error',
        title: 'L·ªói',
        text: message,
        confirmButtonColor: '#667eea'
    });
}


async function deleteHoaDon(id, maHoaDon) {
    try {
        // Hi·ªÉn th·ªã c·∫£nh b√°o x√°c nh·∫≠n
        const results = await Swal.fire({
            title: 'X√°c nh·∫≠n x√≥a?',
            text: `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a h√≥a ƒë∆°n ${maHoaDon}? H√†nh ƒë·ªông n√†y s·∫Ω:\n‚Ä¢ X√≥a vƒ©nh vi·ªÖn h√≥a ƒë∆°n\n‚Ä¢ Ho√†n tr·∫£ t·ªìn kho c√°c m·∫∑t h√†ng ƒë√£ s·ª≠ d·ª•ng\n‚Ä¢ Chuy·ªÉn tr·∫°ng th√°i ph√≤ng v·ªÅ "Tr·ªëng"\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'X√≥a',
            cancelButtonText: 'H·ªßy',
            width: '500px'
        });

        if (!results.isConfirmed) {
            return;
        }

        // Hi·ªÉn th·ªã loading
        Swal.fire({
            title: 'ƒêang x√≥a h√≥a ƒë∆°n...',
            text: 'ƒêang ho√†n tr·∫£ t·ªìn kho v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i ph√≤ng...',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        // G·ªçi API x√≥a h√≥a ƒë∆°n
        const response = await fetch(`/api/delete/hoadon/${maHoaDon}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.error || 'X√≥a h√≥a ƒë∆°n th·∫•t b·∫°i');
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
        await Swal.fire({
            icon: 'success',
            title: 'ƒê√£ x√≥a!',
            html: `
                <div style="text-align: left;">
                    <p><strong>H√≥a ƒë∆°n ${maHoaDon} ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!</strong></p>
                    <p>‚Ä¢ ƒê√£ x√≥a ${result.data.soChiTietDaXoa} d·ªãch v·ª•</p>
                    ${result.data.maPhong ? `<p>‚Ä¢ Ph√≤ng ${result.data.maPhong} ƒë√£ chuy·ªÉn v·ªÅ tr·∫°ng th√°i "Tr·ªëng"</p>` : ''}
                    <p>‚Ä¢ ƒê√£ ho√†n tr·∫£ t·ªìn kho c√°c m·∫∑t h√†ng</p>
                </div>
            `,
            confirmButtonText: 'ƒê√≥ng',
            confirmButtonColor: '#667eea',
            width: '500px'
        });

        // X√≥a card h√≥a ƒë∆°n kh·ªèi UI ngay l·∫≠p t·ª©c
        removeHoaDonFromUI(maHoaDon);

    } catch (error) {
        console.error('‚ùå L·ªói khi x√≥a h√≥a ƒë∆°n:', error);
        Swal.fire({
            icon: 'error',
            title: 'L·ªói!',
            text: error.message || 'Kh√¥ng th·ªÉ x√≥a h√≥a ƒë∆°n',
            confirmButtonColor: '#667eea'
        });
    }
}

// H√†m x√≥a h√≥a ƒë∆°n kh·ªèi UI
function removeHoaDonFromUI(maHoaDon) {
    const hoaDonCard = document.querySelector(`.employee-card[data-mahd="${maHoaDon}"]`);
    
    if (hoaDonCard) {
        // Th√™m hi·ªáu ·ª©ng fade out tr∆∞·ªõc khi x√≥a
        hoaDonCard.style.transition = 'all 0.3s ease';
        hoaDonCard.style.opacity = '0';
        hoaDonCard.style.transform = 'translateX(-100px)';
        
        setTimeout(() => {
            hoaDonCard.remove();
            console.log('‚úÖ ƒê√£ x√≥a h√≥a ƒë∆°n kh·ªèi UI:', maHoaDon);
            
            // C·∫≠p nh·∫≠t th·ªëng k√™
            calculateStatistics();
            
            // Ki·ªÉm tra v√† hi·ªÉn th·ªã empty state n·∫øu c·∫ßn
            const remainingCards = document.querySelectorAll('.employee-card');
            toggleEmptyState(remainingCards.length === 0);
            
            // C·∫≠p nh·∫≠t danh s√°ch ph√≤ng tr·ªëng
            updateAvailableRoomsList();
            
        }, 300);
    } else {
        // N·∫øu kh√¥ng t√¨m th·∫•y card, reload trang ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªìng b·ªô
        console.warn('‚ùå Kh√¥ng t√¨m th·∫•y card h√≥a ƒë∆°n, reload trang...');
        setTimeout(() => {
            location.reload();
        }, 1000);
    }
}

async function thanhToanHoaDon(maHoaDon) {
    try {
        // Hi·ªÉn th·ªã c·∫£nh b√°o x√°c nh·∫≠n
        const result = await Swal.fire({
            title: 'X√°c nh·∫≠n thanh to√°n?',
            text: `B·∫°n c√≥ ch·∫Øc mu·ªën thanh to√°n h√≥a ƒë∆°n ${maHoaDon}?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Thanh to√°n',
            cancelButtonText: 'H·ªßy',
            width: '500px'
        });

        if (!result.isConfirmed) {
            return;
        }

        // Hi·ªÉn th·ªã loading
        Swal.fire({
            title: 'ƒêang x·ª≠ l√Ω thanh to√°n...',
            text: 'Vui l√≤ng ch·ªù trong gi√¢y l√°t',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        // L·∫•y th√¥ng tin h√≥a ƒë∆°n hi·ªán t·∫°i
        const [hoaDonResponse, chiTietResponse] = await Promise.all([
            fetch(`/api/hoadon/${maHoaDon}`),
            fetch(`/api/chitiethoadon/${maHoaDon}`)
        ]);

        if (!hoaDonResponse.ok || !chiTietResponse.ok) {
            throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin h√≥a ƒë∆°n');
        }

        const hoaDon = await hoaDonResponse.json();
        const chiTietHoaDon = await chiTietResponse.json();

        // L·∫•y th·ªùi gian hi·ªán t·∫°i
        const now = new Date();
        const thoiGianKetThuc = now.toISOString();

        // L·∫•y b·∫£ng gi√° ph√≤ng ƒë·ªÉ t√≠nh to√°n
        const bangGiaResponse = await fetch(`/api/hoadon/banggia/${hoaDon.MaPhong}`);
        if (!bangGiaResponse.ok) {
            throw new Error('Kh√¥ng th·ªÉ t·∫£i b·∫£ng gi√° ph√≤ng');
        }
        const bangGia = await bangGiaResponse.json();

        // T√≠nh to√°n ti·ªÅn ph√≤ng m·ªõi d·ª±a tr√™n th·ªùi gian th·ª±c t·∫ø
        const tienPhongMoi = calculateActualRoomPrice(
            hoaDon.ThoiGianBatDau, 
            thoiGianKetThuc, 
            bangGia
        );

        // T√≠nh t·ªïng ti·ªÅn d·ªãch v·ª• (lo·∫°i tr·ª´ Thu√™ ph√≤ng)
        const tienDichVu = Array.isArray(chiTietHoaDon) 
            ? chiTietHoaDon
                .filter(item => item.LoaiDichVu !== 'Thu√™ ph√≤ng')
                .reduce((sum, item) => sum + (item.ThanhTien || 0), 0)
            : 0;

        // T·ªïng ti·ªÅn m·ªõi
        const tongTienMoi = tienPhongMoi + tienDichVu;

        console.log('üí∞ T√≠nh to√°n thanh to√°n:', {
            tienPhongCu: hoaDon.TongTien - tienDichVu,
            tienPhongMoi: tienPhongMoi,
            tienDichVu: tienDichVu,
            tongTienMoi: tongTienMoi,
            thoiGianBatDau: hoaDon.ThoiGianBatDau,
            thoiGianKetThuc: thoiGianKetThuc
        });

        // G·ª≠i y√™u c·∫ßu c·∫≠p nh·∫≠t thanh to√°n
        const updateResponse = await fetch(`/api/hoadon/thanhtoan/${maHoaDon}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                thoiGianKetThuc: thoiGianKetThuc,
                tienPhong: tienPhongMoi,
                tongTien: tongTienMoi,
                trangThai: 'ƒê√£ thanh to√°n'
            })
        });

        if (!updateResponse.ok) {
            const errorResult = await updateResponse.json();
            throw new Error(errorResult.error || 'C·∫≠p nh·∫≠t thanh to√°n th·∫•t b·∫°i');
        }

        const updateResult = await updateResponse.json();

        // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng v·ªõi th√¥ng tin chi ti·∫øt
        await Swal.fire({
            icon: 'success',
            title: 'Thanh to√°n th√†nh c√¥ng!',
            html: `
                <div style="text-align: left;">
                    <p><strong>M√£ Hƒê:</strong> ${maHoaDon}</p>
                    <p><strong>Th·ªùi gian:</strong> ${formatTime(hoaDon.ThoiGianBatDau)} - ${formatTime(thoiGianKetThuc)}</p>
                    <p><strong>Ti·ªÅn ph√≤ng:</strong> ${formatNumber(tienPhongMoi)} VND</p>
                    <p><strong>Ti·ªÅn d·ªãch v·ª•:</strong> ${formatNumber(tienDichVu)} VND</p>
                    <p><strong>T·ªïng c·ªông:</strong> ${formatNumber(tongTienMoi)} VND</p>
                </div>
            `,
            confirmButtonText: 'ƒê√≥ng',
            confirmButtonColor: '#667eea',
            width: '500px'
        });

        // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c m√† kh√¥ng c·∫ßn reload
        updateHoaDonUI(maHoaDon, {
            trangThai: 'ƒê√£ thanh to√°n',
            tongTien: tongTienMoi,
            thoiGianKetThuc: thoiGianKetThuc
        });

    } catch (error) {
        console.error('‚ùå L·ªói thanh to√°n h√≥a ƒë∆°n:', error);
        Swal.fire({
            icon: 'error',
            title: 'L·ªói!',
            text: error.message || 'Kh√¥ng th·ªÉ th·ª±c hi·ªán thanh to√°n',
            confirmButtonColor: '#667eea'
        });
    }
}

function calculateActualRoomPrice(thoiGianBatDau, thoiGianKetThuc, bangGia) {
    if (!thoiGianBatDau || !thoiGianKetThuc || !Array.isArray(bangGia)) {
        console.warn('‚ùå Thi·∫øu d·ªØ li·ªáu ƒë·ªÉ t√≠nh to√°n ti·ªÅn ph√≤ng');
        return 0;
    }

    const start = new Date(thoiGianBatDau);
    const end = new Date(thoiGianKetThuc);
    
    // T√≠nh t·ªïng s·ªë ph√∫t s·ª≠ d·ª•ng
    const totalMinutes = Math.max(0, (end - start) / (1000 * 60));
    
    console.log(`‚è±Ô∏è Th·ªùi gian s·ª≠ d·ª•ng: ${totalMinutes.toFixed(2)} ph√∫t (${formatTime(start)} - ${formatTime(end)})`);

    if (totalMinutes <= 0) {
        console.warn('‚ö†Ô∏è Th·ªùi gian s·ª≠ d·ª•ng kh√¥ng h·ª£p l·ªá');
        return 0;
    }

    // T√¨m khung gi·ªù ph√π h·ª£p v·ªõi th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu
    const startHour = start.getHours();
    const startMinute = start.getMinutes();
    const startTotalMinutes = startHour * 60 + startMinute;

    console.log(`üïí Gi·ªù b·∫Øt ƒë·∫ßu: ${startHour}:${startMinute.toString().padStart(2, '0')} (${startTotalMinutes} ph√∫t)`);

    let foundPrice = 0;
    let foundTimeSlot = '';

    for (const gia of bangGia) {
        if (!gia.KhungGio) continue;

        const [batDauStr, ketThucStr] = gia.KhungGio.split('-');
        if (!batDauStr || !ketThucStr) continue;

        const [gioBatDau, phutBatDau] = batDauStr.split(':').map(Number);
        const [gioKetThuc, phutKetThuc] = ketThucStr.split(':').map(Number);
        
        const thoiGianBatDauPhut = gioBatDau * 60 + phutBatDau;
        const thoiGianKetThucPhut = gioKetThuc * 60 + phutKetThuc;

        console.log(`üîç Ki·ªÉm tra khung gi·ªù: ${gia.KhungGio} (${thoiGianBatDauPhut} - ${thoiGianKetThucPhut} ph√∫t)`);

        let isMatch = false;
        const isQuaNgay = thoiGianBatDauPhut >= thoiGianKetThucPhut;

        if (isQuaNgay) {
            // KHUNG GI·ªú QUA NG√ÄY (v√≠ d·ª•: 18:00-03:00)
            // Ki·ªÉm tra: n·∫øu th·ªùi gian n·∫±m trong [batDau, 24:00) ho·∫∑c [00:00, ketThuc]
            if (startTotalMinutes >= thoiGianBatDauPhut || startTotalMinutes < thoiGianKetThucPhut) {
                isMatch = true;
                console.log(`‚úÖ Khung qua ng√†y ${gia.KhungGio} PH√ô H·ª¢P`);
            }
        } else {
            // KHUNG GI·ªú TRONG C√ôNG NG√ÄY
            if (startTotalMinutes >= thoiGianBatDauPhut && startTotalMinutes < thoiGianKetThucPhut) {
                isMatch = true;
                console.log(`‚úÖ Khung trong ng√†y ${gia.KhungGio} PH√ô H·ª¢P`);
            }
        }

        if (isMatch) {
            foundPrice = gia.GiaTien || 0;
            foundTimeSlot = gia.KhungGio;
            break;
        }
    }

    if (foundPrice === 0) {
        console.warn('‚ùå Kh√¥ng t√¨m th·∫•y khung gi·ªù ph√π h·ª£p, s·ª≠ d·ª•ng gi√° m·∫∑c ƒë·ªãnh');
        if (bangGia.length > 0 && bangGia[0].GiaTien) {
            foundPrice = bangGia[0].GiaTien;
            foundTimeSlot = bangGia[0].KhungGio;
        } else {
            return 0;
        }
    }

    // T√≠nh gi√° theo ph√∫t (gi√° gi·ªù / 60)
    const pricePerMinute = foundPrice / 60;
    const totalPrice = totalMinutes * pricePerMinute;
    
    console.log(`üí∞ T√≠nh to√°n chi ti·∫øt:`);
    console.log(`   - Gi√°/gi·ªù: ${formatNumber(foundPrice)} VND`);
    console.log(`   - Gi√°/ph√∫t: ${formatNumber(pricePerMinute)} VND`);
    console.log(`   - S·ªë ph√∫t: ${totalMinutes.toFixed(2)} ph√∫t`);
    console.log(`   - T·ªïng ti·ªÅn: ${totalMinutes.toFixed(2)} √ó ${formatNumber(pricePerMinute)} = ${formatNumber(totalPrice)} VND`);

    // L√†m tr√≤n ƒë·∫øn h√†ng ngh√¨n
    const roundedPrice = Math.round(totalPrice / 1000) * 1000;
    
    console.log(`üí∞ T·ªïng ti·ªÅn ph√≤ng (ƒë√£ l√†m tr√≤n): ${formatNumber(roundedPrice)} VND`);
    return roundedPrice;
}
  
// H√†m t√≠nh s·ªë ph√∫t ch·ªìng l·∫•n cho khung gi·ªù trong ng√†y
function calculateOverlapMinutes(startTime, endTime, slotStartMinute, slotEndMinute) {
    const start = new Date(startTime);
    const end = new Date(endTime);
    
    // T·∫°o th·ªùi gian b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c c·ªßa khung gi·ªù trong c√πng ng√†y
    const slotStart = new Date(start);
    slotStart.setHours(Math.floor(slotStartMinute / 60), slotStartMinute % 60, 0, 0);

    const slotEnd = new Date(start);
    slotEnd.setHours(Math.floor(slotEndMinute / 60), slotEndMinute % 60, 0, 0);

    // N·∫øu slotEnd nh·ªè h∆°n slotStart, nghƒ©a l√† qua ng√†y - kh√¥ng x·ª≠ l√Ω ·ªü ƒë√¢y
    if (slotEnd <= slotStart) {
        return 0;
    }

    // T√≠nh th·ªùi gian giao nhau
    const overlapStart = new Date(Math.max(start.getTime(), slotStart.getTime()));
    const overlapEnd = new Date(Math.min(end.getTime(), slotEnd.getTime()));

    if (overlapStart >= overlapEnd) {
        return 0;
    }

    const overlapMinutes = (overlapEnd - overlapStart) / (1000 * 60);
    return Math.max(0, overlapMinutes);
}

// H√†m t√≠nh s·ªë ph√∫t ch·ªìng l·∫•n cho khung gi·ªù qua ng√†y
function calculateOverlapMinutesForOvernight(startTime, endTime, slotStartMinute, slotEndMinute) {
    const start = new Date(startTime);
    const end = new Date(endTime);
    
    let totalMinutes = 0;

    // Ph·∫ßn 1: T·ª´ slotStartMinute ƒë·∫øn cu·ªëi ng√†y (1440 ph√∫t)
    const slotStartDay1 = new Date(start);
    slotStartDay1.setHours(Math.floor(slotStartMinute / 60), slotStartMinute % 60, 0, 0);

    const slotEndDay1 = new Date(start);
    slotEndDay1.setHours(23, 59, 59, 999); // Cu·ªëi ng√†y

    const overlapStart1 = new Date(Math.max(start.getTime(), slotStartDay1.getTime()));
    const overlapEnd1 = new Date(Math.min(end.getTime(), slotEndDay1.getTime()));

    if (overlapStart1 < overlapEnd1) {
        const minutes1 = (overlapEnd1 - overlapStart1) / (1000 * 60);
        totalMinutes += Math.max(0, minutes1);
    }

    // Ph·∫ßn 2: T·ª´ ƒë·∫ßu ng√†y ti·∫øp theo ƒë·∫øn slotEndMinute (ƒë√£ tr·ª´ 1440)
    const slotStartDay2 = new Date(start);
    slotStartDay2.setDate(slotStartDay2.getDate() + 1);
    slotStartDay2.setHours(0, 0, 0, 0); // ƒê·∫ßu ng√†y ti·∫øp theo

    const slotEndDay2 = new Date(start);
    slotEndDay2.setDate(slotEndDay2.getDate() + 1);
    slotEndDay2.setHours(Math.floor((slotEndMinute - 1440) / 60), (slotEndMinute - 1440) % 60, 0, 0);

    const overlapStart2 = new Date(Math.max(start.getTime(), slotStartDay2.getTime()));
    const overlapEnd2 = new Date(Math.min(end.getTime(), slotEndDay2.getTime()));

    if (overlapStart2 < overlapEnd2) {
        const minutes2 = (overlapEnd2 - overlapStart2) / (1000 * 60);
        totalMinutes += Math.max(0, minutes2);
    }

    return totalMinutes;
}

function updateHoaDonUI(maHoaDon, updatedData) {
    const hoaDonCard = document.querySelector(`.employee-card[data-mahd="${maHoaDon}"]`);
    
    if (!hoaDonCard) {
        console.warn('‚ùå Kh√¥ng t√¨m th·∫•y card h√≥a ƒë∆°n ƒë·ªÉ c·∫≠p nh·∫≠t:', maHoaDon);
        return;
    }

    // C·∫≠p nh·∫≠t data attributes
    hoaDonCard.setAttribute('data-status', updatedData.trangThai);
    hoaDonCard.setAttribute('data-tongtien', updatedData.tongTien);

    // C·∫≠p nh·∫≠t badge tr·∫°ng th√°i
    const statusBadge = hoaDonCard.querySelector('.employee-badge');
    if (statusBadge) {
        statusBadge.textContent = updatedData.trangThai;
        statusBadge.className = `employee-badge ${updatedData.trangThai}`;
    }

    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã t·ªïng ti·ªÅn
    const statusDisplay = hoaDonCard.querySelector('.employee-status');
    if (statusDisplay) {
        statusDisplay.textContent = `${formatNumber(updatedData.tongTien)} VND`;
        statusDisplay.className = `employee-status active`; // ƒê√£ thanh to√°n -> active
    }

    // C·∫≠p nh·∫≠t th·ªùi gian k·∫øt th√∫c trong details
    const detailItems = hoaDonCard.querySelectorAll('.detail-item');
    detailItems.forEach(item => {
        if (item.textContent.includes('K·∫øt th√∫c:')) {
            const timeSpan = item.querySelector('span');
            if (timeSpan) {
                if (updatedData.thoiGianKetThuc) {
                    timeSpan.textContent = `K·∫øt th√∫c: ${formatTime(updatedData.thoiGianKetThuc)}`;
                    timeSpan.className = ''; // X√≥a highlight
                } else {
                    timeSpan.textContent = 'K·∫øt th√∫c: ƒê√£ thanh to√°n';
                }
            }
        }
    });

    // C·∫≠p nh·∫≠t n√∫t h√†nh ƒë·ªông
    const footer = hoaDonCard.querySelector('.employee-footer');
    if (footer) {
        footer.innerHTML = `
            <button class="btn-detail" data-mahd="${maHoaDon}">
                <i class="fas fa-eye"></i>
                Xem chi ti·∫øt
            </button>
            <button class="btn-print" data-mahd="${maHoaDon}">
                <i class="fas fa-print"></i>
                In h√≥a ƒë∆°n
            </button>
        `;
    }

    // ·∫®n n√∫t edit (n·∫øu c√≥)
    const editButton = hoaDonCard.querySelector('.btn-edit');
    if (editButton) {
        editButton.style.display = 'none';
    }

    console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t UI cho h√≥a ƒë∆°n:', maHoaDon);
}

function printHoaDon(maHoaDon) {
    // TODO: Implement print functionality
    showError('T√≠nh nƒÉng in h√≥a ƒë∆°n ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
}

async function viewHoaDonDetail(maHoaDon) {
    try {
      // Hi·ªÉn th·ªã loading
      const detailContent = document.getElementById('detailContent');
      detailContent.innerHTML = `
        <div class="loading-invoice">
          <div class="loading-spinner"></div>
          <p>ƒêang t·∫£i th√¥ng tin h√≥a ƒë∆°n...</p>
        </div>
      `;
      
      // C·∫≠p nh·∫≠t ng√†y xu·∫•t v·ªõi th·ªùi gian hi·ªán t·∫°i
      const now = new Date();
      document.getElementById('modal-invoice-date').textContent = 
        `${formatDate(now)} ${formatTime(now)}`;
      
      document.getElementById('detailModal').style.display = 'flex';

      // L·∫•y th√¥ng tin h√≥a ƒë∆°n v√† chi ti·∫øt song song
      const [chiTietResponse, hoaDonResponse] = await Promise.all([
        fetch(`/api/chitiethoadon/${maHoaDon}`),
        fetch(`/api/hoadon/${maHoaDon}`)
      ]);

      if (!chiTietResponse.ok || !hoaDonResponse.ok) {
        throw new Error('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h√≥a ƒë∆°n');
      }

      const chiTietHoaDon = await chiTietResponse.json();
      const hoaDon = await hoaDonResponse.json();

      console.log('Chi ti·∫øt h√≥a ƒë∆°n:', chiTietHoaDon);
      console.log('Th√¥ng tin h√≥a ƒë∆°n:', hoaDon);

      // C·∫¨P NH·∫¨T HEADER V·ªöI TH√îNG TIN T·ª™ API
      document.getElementById('modal-invoice-number').textContent = `${hoaDon.MaHoaDon}`;
      
      const statusElement = document.getElementById('modal-invoice-status');
      statusElement.textContent = hoaDon.TrangThai;
      statusElement.className = `value status-badge ${hoaDon.TrangThai === 'ƒê√£ thanh to√°n' ? 'paid' : hoaDon.TrangThai === 'Ch∆∞a thanh to√°n' ? 'pending' : 'cancelled'}`;

      // C·∫¨P NH·∫¨T N√öT H√ÄNH ƒê·ªòNG TRONG HEADER
      updateHeaderActions(maHoaDon, hoaDon.TrangThai);

      // T√≠nh t·ªïng ti·ªÅn d·ªãch v·ª•
      const tongTienDichVu = Array.isArray(chiTietHoaDon) 
        ? chiTietHoaDon.reduce((sum, item) => sum + (item.ThanhTien || 0), 0)
        : 0;

      // Render ph·∫ßn body c·ªßa h√≥a ƒë∆°n
      renderInvoiceBody(hoaDon, chiTietHoaDon, tongTienDichVu);

    } catch (error) {
      console.error('L·ªói khi t·∫£i chi ti·∫øt h√≥a ƒë∆°n:', error);
      detailContent.innerHTML = `
        <div class="error-state">
          <div class="error-icon">‚ùå</div>
          <h3>Kh√¥ng th·ªÉ t·∫£i h√≥a ƒë∆°n</h3>
          <p>${error.message || 'Vui l√≤ng th·ª≠ l·∫°i sau'}</p>
          <button class="btn-primary" onclick="viewHoaDonDetail('${maHoaDon}')">
            <i class="fas fa-redo"></i>
            Th·ª≠ l·∫°i
          </button>
        </div>
      `;
    }
  }

// ===== RENDER PH·∫¶N BODY C·ª¶A H√ìA ƒê∆†N =====
  function renderInvoiceBody(hoaDon, chiTietHoaDon, tongTienDichVu) {
    const detailContent = document.getElementById('detailContent');
    
    // T√≠nh c√°c th√†nh ph·∫ßn ti·ªÅn
    const tienPhong = (hoaDon.TongTien || 0) - tongTienDichVu;
    const vat = (hoaDon.TongTien || 0) * 0.1; // VAT 10%
    const tongThanhToan = (hoaDon.TongTien || 0) + vat;

    detailContent.innerHTML = `
      <div class="modern-invoice" id="printableInvoice">
        <!-- Th√¥ng tin kh√°ch h√†ng v√† ph√≤ng -->
        <div class="invoice-customer-info">
          <div class="info-section">
            <h3>Th√¥ng tin kh√°ch h√†ng</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="label">M√£ KH:</span>
                <span class="value">${hoaDon.MaKH || 'N/A'}</span>
              </div>
              <div class="info-item">
                <span class="label">ƒê·∫∑t ph√≤ng:</span>
                <span class="value">${hoaDon.MaDatPhong || 'N/A'}</span>
              </div>
            </div>
          </div>
          <div class="info-section">
            <h3>Th√¥ng tin ph√≤ng</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="label">Ph√≤ng:</span>
                <span class="value">${hoaDon.MaPhong || 'N/A'}</span>
              </div>
              <div class="info-item">
                <span class="label">Th·ªùi gian:</span>
                <span class="value">${formatTime(hoaDon.ThoiGianBatDau)} - ${formatTime(hoaDon.ThoiGianKetThuc)}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- B·∫£ng d·ªãch v·ª• -->
        <div class="invoice-services">
          <h3>Chi ti·∫øt d·ªãch v·ª• s·ª≠ d·ª•ng</h3>
          <div class="services-table">
            <div class="table-header">
              <div class="col-service">D·ªãch v·ª•</div>
              <div class="col-quantity">S·ªë l∆∞·ª£ng</div>
              <div class="col-price">ƒê∆°n gi√°</div>
              <div class="col-total">Th√†nh ti·ªÅn</div>
            </div>
            
            ${tienPhong >= 0 ? `
            <div class="table-row">
              <div class="col-service">
                <span class="service-name">Thu√™ ph√≤ng ${hoaDon.MaPhong}</span>
                <span class="service-desc">${formatTime(hoaDon.ThoiGianBatDau)} - ${formatTime(hoaDon.ThoiGianKetThuc)}</span>
              </div>
              <div class="col-quantity">1</div>
              <div class="col-price">${formatNumber(tienPhong)}</div>
              <div class="col-total">${formatNumber(tienPhong)}</div>
            </div>
            ` : ''}
            
            ${Array.isArray(chiTietHoaDon) && chiTietHoaDon.length > 0 ? chiTietHoaDon.filter(item => item.LoaiDichVu !== 'Thu√™ ph√≤ng').map(item => `
                    <div class="table-row">
                      <div class="col-service">
                        <span class="service-name">${item.TenHang || item.MaHang || 'N/A'}</span>
                        <span class="service-desc">${item.LoaiDichVu || 'D·ªãch v·ª•'}</span>
                      </div>
                      <div class="col-quantity">${item.SoLuong}</div>
                      <div class="col-price">${formatNumber(item.DonGia)}</div>
                      <div class="col-total">${formatNumber(item.ThanhTien)}</div>
                    </div>
                  `).join('')
              : '<div class="table-row no-services"><div class="col-service">Kh√¥ng c√≥ d·ªãch v·ª• n√†o</div></div>'
            }
          </div>
        </div>

        <!-- T·ªïng k·∫øt h√≥a ƒë∆°n -->
        <div class="invoice-summary">
          <div class="summary-row">
            <span class="label">T·ªïng ti·ªÅn d·ªãch v·ª•:</span>
            <span class="value">${formatNumber(hoaDon.TongTien || 0)}</span>
          </div>
          <div class="summary-row">
            <span class="label">VAT (10%):</span>
            <span class="value">${formatNumber(vat)}</span>
          </div>
          <div class="summary-row total">
            <span class="label">T·ªîNG C·ªòNG:</span>
            <span class="value">${formatNumber(tongThanhToan)}</span>
          </div>
        </div>

        <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
        <div class="invoice-payment">
          <div class="payment-method">
            <h4>Ph∆∞∆°ng th·ª©c thanh to√°n</h4>
            <div class="method ${hoaDon.TrangThai === 'ƒê√£ thanh to√°n' ? 'paid' : 'cash'}">
              <i class="fas ${hoaDon.TrangThai === 'ƒê√£ thanh to√°n' ? 'fa-credit-card' : 'fa-money-bill-wave'}"></i>
              <span>${hoaDon.TrangThai === 'ƒê√£ thanh to√°n' ? 'Th·∫ª t√≠n d·ª•ng' : 'Ti·ªÅn m·∫∑t'}</span>
            </div>
          </div>
          <div class="payment-notes">
            <h4>Ghi ch√∫</h4>
            <p>C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ s·ª≠ d·ª•ng d·ªãch v·ª• c·ªßa ch√∫ng t√¥i!</p>
            <p>H·∫πn g·∫∑p l·∫°i qu√Ω kh√°ch trong nh·ªØng l·∫ßn ti·∫øp theo.</p>
          </div>
        </div>

        <!-- Footer h√≥a ƒë∆°n -->
        <div class="invoice-footer">
          <div class="footer-signature">
            <div class="signature-line"></div>
            <p>Ch·ªØ k√Ω nh√¢n vi√™n</p>
          </div>
          <div class="footer-thanks">
            <p><strong>KARAOKE NNICE</strong></p>
            <p>Hotline: (028) 35 170 046</p>
          </div>
        </div>
      </div>
    `;
  }

  function printInvoice() {
    const printableElement = document.getElementById('printableInvoice');
    if (!printableElement) return;

    const printWindow = window.open('', '_blank', 'width=800,height=600');
    
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
        <head>
          <title>H√≥a ƒë∆°n ${document.getElementById('modal-invoice-number').textContent}</title>
          <style>
            ${getInvoiceStyles()}
            
            /* CSS ri√™ng cho in ·∫•n */
            @media print {
              body { margin: 0; padding: 20px; }
              .modern-invoice { 
                box-shadow: none; 
                border: 1px solid #ddd;
                padding: 20px;
              }
              .btn-print-invoice, .btn-download-invoice, .btn-pay-invoice, .modal-close { 
                display: none !important; 
              }
            }
          </style>
        </head>
        <body>
          ${printableElement.outerHTML}
          <script>
            window.onload = function() {
              window.print();
              setTimeout(() => window.close(), 500);
            };
          <\/script>
        </body>
      </html>
    `);
    
    printWindow.document.close();
  }

function updateHeaderActions(maHoaDon, trangThai) {
    const headerActions = document.getElementById('headerActions');
    
    let actionButtons = `
      <button class="btn-print-invoice" onclick="printInvoice()">
        <i class="fas fa-print"></i>
        In h√≥a ƒë∆°n
      </button>
    `;
    
    if (trangThai === 'Ch∆∞a thanh to√°n') {
      actionButtons += `
        <button class="btn-pay-invoice" onclick="thanhToanHoaDon('${maHoaDon}')">
          <i class="fas fa-credit-card"></i>
          Thanh to√°n
        </button>
      `;
    } else {
      actionButtons += `
        <button class="btn-download-invoice" onclick="downloadInvoice()">
          <i class="fas fa-download"></i>
          T·∫£i PDF
        </button>
      `;
    }
    
    actionButtons += `
      <button class="modal-close" onclick="closeDetailModal()">
        <i class="fas fa-times"></i>
      </button>
    `;
    
    headerActions.innerHTML = actionButtons;
  }

function downloadInvoice() {
    Swal.fire({
      title: 'ƒêang t·∫£i PDF...',
      text: 'H√≥a ƒë∆°n ƒëang ƒë∆∞·ª£c xu·∫•t ra file PDF',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    setTimeout(() => {
      Swal.fire({
        icon: 'success',
        title: 'Th√†nh c√¥ng!',
        text: 'H√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c t·∫£i xu·ªëng',
        timer: 1500,
        showConfirmButton: false
      });
    }, 2000);
  }
  function closeDetailModal() {
    document.getElementById('detailModal').style.display = 'none';
  }

function formatDateTimeLocal(dateString) {
    if (!dateString) return '';
    
    try {
        const date = new Date(dateString);
        
        // Format th√†nh YYYY-MM-DDTHH:mm
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    } catch (error) {
        console.error('‚ùå L·ªói format datetime:', error);
        return '';
    }
}

// H√†m ph·ª• tr·ª£ ƒë·ªãnh d·∫°ng th·ªùi gian
function formatTimeForDisplay(hours, minutes) {
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
}

// H√†m t√≠nh to√°n gi√° ph√≤ng d·ª±a tr√™n TH·ªúI GIAN (c√≥ x·ª≠ l√Ω qua ng√†y h√¥m sau)
function calculateRoomPrice(thoiGianBatDau, bangGia) {
    if (!thoiGianBatDau || !bangGia || !Array.isArray(bangGia)) {
        console.warn('‚ùå Kh√¥ng c√≥ th·ªùi gian b·∫Øt ƒë·∫ßu ho·∫∑c b·∫£ng gi√°');
        return 0;
    }
    console.log('Time Back: ', thoiGianBatDauComeBack);

    const thoiGian = new Date(thoiGianBatDau);
    const gioHienTai = thoiGian.getHours();
    const phutHienTai = thoiGian.getMinutes();
    const thoiGianHienTai = gioHienTai * 60 + phutHienTai;

    console.log(`üïí Th·ªùi gian b·∫Øt ƒë·∫ßu: ${gioHienTai}:${phutHienTai.toString().padStart(2, '0')}`);
    console.log(`üìä S·ªë khung gi·ªù trong b·∫£ng gi√°: ${bangGia.length}`);

    let foundPrice = 0;
    let foundTimeSlot = '';
    let hasValidTimeSlot = false;

    for (const gia of bangGia) {
        if (!gia.KhungGio) continue;

        const [batDauStr, ketThucStr] = gia.KhungGio.split('-');
        if (!batDauStr || !ketThucStr) continue;

        // Chuy·ªÉn ƒë·ªïi th·ªùi gian b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c th√†nh ph√∫t
        const [gioBatDau, phutBatDau] = batDauStr.split(':').map(Number);
        const [gioKetThuc, phutKetThuc] = ketThucStr.split(':').map(Number);
        
        let thoiGianBatDauPhut = gioBatDau * 60 + phutBatDau;
        let thoiGianKetThucPhut = gioKetThuc * 60 + phutKetThuc;

        console.log(`‚è∞ Ki·ªÉm tra khung gi·ªù: ${gia.KhungGio}, Gi√°: ${gia.GiaTien}`);

        let isMatch = false;
        const isQuaNgay = thoiGianBatDauPhut >= thoiGianKetThucPhut;

        if (isQuaNgay) {
            // KHUNG GI·ªú QUA NG√ÄY: th·ªùi gian k·∫øt th√∫c ph·∫£i + th√™m 1 ng√†y (1440 ph√∫t)
            thoiGianKetThucPhut += 1440; // Th√™m 24 gi·ªù (1440 ph√∫t)
            
            // T·∫°o th·ªùi gian hi·ªán t·∫°i m·ªü r·ªông ƒë·ªÉ so s√°nh
            // N·∫øu th·ªùi gian hi·ªán t·∫°i < th·ªùi gian b·∫Øt ƒë·∫ßu, coi nh∆∞ n√≥ thu·ªôc ng√†y h√¥m sau
            const thoiGianHienTaiExtended = thoiGianHienTai < thoiGianBatDauPhut 
                ? thoiGianHienTai + 1440 
                : thoiGianHienTai;
            
            isMatch = (thoiGianHienTaiExtended >= thoiGianBatDauPhut && 
                      thoiGianHienTaiExtended < thoiGianKetThucPhut);
            
            console.log(`   üåô Khung gi·ªù qua ng√†y - Th·ªùi gian m·ªü r·ªông: ${thoiGianHienTaiExtended} ph√∫t`);
            console.log(`   üåô Kho·∫£ng th·ªùi gian: ${thoiGianBatDauPhut} - ${thoiGianKetThucPhut} ph√∫t`);
        } else {
            // KHUNG GI·ªú TRONG C√ôNG NG√ÄY
            isMatch = (thoiGianHienTai >= thoiGianBatDauPhut && 
                      thoiGianHienTai < thoiGianKetThucPhut);
            
            console.log(`   üìÖ Khung gi·ªù trong ng√†y - Kho·∫£ng th·ªùi gian: ${thoiGianBatDauPhut} - ${thoiGianKetThucPhut} ph√∫t`);
        }

        console.log(`   K·∫øt qu·∫£: ${isMatch ? '‚úÖ PH√ô H·ª¢P' : '‚ùå KH√îNG PH√ô H·ª¢P'}`);

        if (isMatch) {
            foundPrice = gia.GiaTien || 0;
            foundTimeSlot = gia.KhungGio;
            hasValidTimeSlot = true;
            
            // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu l√† khung gi·ªù qua ng√†y
            {{!-- if (isQuaNgay) {
                foundTimeSlot += " (qua ng√†y)";
                Swal.fire({
                    icon: 'info',
                    title: 'Khung gi·ªù qua ng√†y',
                    html: `√Åp d·ª•ng khung gi·ªù <strong>${foundTimeSlot}</strong><br>
                          Gi√°: <strong>${formatNumber(foundPrice)} VND</strong>`,
                    timer: 2000,
                    showConfirmButton: false
                });
            } --}}
            
            thoiGianBatDauComeBack = formatToISODateTimeSimple(document.getElementById('thoiGianBatDau').value);
            console.log('TIME BACK: ',thoiGianBatDauComeBack);
            break;
        }
    }

    // X·ª¨ L√ù KHI KH√îNG T√åM TH·∫§Y KHUNG GI·ªú PH√ô H·ª¢P
    if (!hasValidTimeSlot) {
        console.warn('‚ùå Kh√¥ng t√¨m th·∫•y khung gi·ªù ph√π h·ª£p');
        
        // L·∫•y danh s√°ch khung gi·ªù c√≥ s·∫µn
        const khungGioList = bangGia
            .filter(gia => gia.KhungGio)
            .map(gia => {
                const [batDau, ketThuc] = gia.KhungGio.split('-');
                const [gioBatDau, phutBatDau] = batDau.split(':').map(Number);
                const [gioKetThuc, phutKetThuc] = ketThuc.split(':').map(Number);
                const thoiGianBatDauPhut = gioBatDau * 60 + phutBatDau;
                const thoiGianKetThucPhut = gioKetThuc * 60 + phutKetThuc;
                const isQuaNgay = thoiGianBatDauPhut >= thoiGianKetThucPhut;
                
                if (isQuaNgay) {
                    return `${gia.KhungGio} (qua ng√†y) - ${formatNumber(gia.GiaTien)} VND`;
                }
                return `${gia.KhungGio} - ${formatNumber(gia.GiaTien)} VND`;
            })
            .filter(Boolean)
            .join('<br>');

        // Hi·ªÉn th·ªã c·∫£nh b√°o chi ti·∫øt
        Swal.fire({
            icon: 'warning',
            title: 'Ngo√†i th·ªùi gian ph·ª•c v·ª•',
            html: `Th·ªùi gian <strong>${formatTimeForDisplay(gioHienTai, phutHienTai)}</strong> kh√¥ng n·∫±m trong khung gi·ªù ph·ª•c v·ª•.<br><br>
                  <strong>C√°c khung gi·ªù hi·ªán c√≥:</strong><br>
                  ${khungGioList}<br><br>
                  Vui l√≤ng ch·ªçn th·ªùi gian trong khung gi·ªù ph√π h·ª£p.`,
            confirmButtonText: 'ƒê√£ hi·ªÉu',
            confirmButtonColor: '#667eea',
            width: '600px'
        }).then((result) => {
          if (result.isConfirmed) {
              document.getElementById('thoiGianBatDau').value = formatDateTimeLocal(thoiGianBatDauComeBack);
              
              // G·ªçi l·∫°i updateRoomPrice ƒë·ªÉ t√≠nh to√°n v·ªõi th·ªùi gian m·ªõi
              updateRoomPrice();
          }
        });
      return 0;
    }

    console.log(`üí∞ √Åp d·ª•ng khung gi·ªù: ${foundTimeSlot}, Gi√°: ${formatNumber(foundPrice)} VND`);
    return foundPrice;
}

function resetRoomForm() {
  document.getElementById('thoiGianBatDau').value = null;
  document.getElementById('giaPhongDisplay').textContent = 0;
  thoiGianBatDauComeBack = null;
}

async function updateRoomPrice() {
    const phongSelect = document.getElementById('phongSelect');
    const selectedOption = phongSelect.options[phongSelect.selectedIndex];
    const thoiGianBatDau = document.getElementById('thoiGianBatDau').value;
    console.log('Th·ªùi gian b·∫Øt ƒë·∫ßu: ', thoiGianBatDau);
    if (thoiGianBatDau === null) {
      document.getElementById('giaPhongDisplay').textContent = 0;
      console.log('reset form ph√≤ng');
      return;
    }
    console.log('Select ph√≤ng ƒëc ch·ªçn: ', phongSelect);
    console.log('Ph√≤ng ƒëc ch·ªçn:' , selectedOption.value);
    const maPhong = selectedOption.value;
    console.log('M√£ Ph√≤ng: ', maPhong);
    try {
        const response = await fetch(`/api/hoadon/banggia/${maPhong}`);
        
        if (!response.ok) {
            throw new Error('Kh√¥ng th·ªÉ t·∫£i b·∫£ng gi√° chi ti·∫øt');
        }
        
        const bangGiaChiTiet = await response.json();
        console.log('Gia', bangGiaChiTiet);
        
        // 3. T√çNH TO√ÅN GI√Å D·ª∞A TR√äN TH·ªúI GIAN V√Ä B·∫¢NG GI√Å
        // Gi·∫£ s·ª≠ h√†m n√†y t√≠nh to√°n t·ªïng ti·ªÅn d·ª±a tr√™n BangGiaChiTiet v√† th·ªùi gian
        const giaPhongTinhToan = calculateRoomPrice(thoiGianBatDau, bangGiaChiTiet);
        
        currentRoomPrice = giaPhongTinhToan;
        document.getElementById('giaPhongDisplay').textContent = formatNumber(giaPhongTinhToan);
        
        console.log(`‚úÖ ƒê√£ t√≠nh to√°n gi√° ph√≤ng: ${giaPhongTinhToan}`);

    } catch (error) {
        console.error('‚ùå L·ªói API khi l·∫•y b·∫£ng gi√°:', error);
        
        // Fallback: S·ª≠ d·ª•ng gi√° c∆° b·∫£n n·∫øu API th·∫•t b·∫°i
        currentRoomPrice = parseFloat(giaCoBan) || 0; 
        document.getElementById('giaPhongDisplay').textContent = formatNumber(currentRoomPrice);
        
        showError(`Kh√¥ng th·ªÉ t√≠nh gi√° ch√≠nh x√°c. S·ª≠ d·ª•ng gi√° c∆° b·∫£n: ${formatNumber(currentRoomPrice)}.`);
    }
  
    calculateTotal();
}
function formatToISODateTimeSimple(dateTimeString) {
    if (!dateTimeString) return '';
    
    try {
        const date = new Date(dateTimeString);
        
        if (isNaN(date.getTime())) {
            console.error('‚ùå Th·ªùi gian kh√¥ng h·ª£p l·ªá:', dateTimeString);
            return '';
        }
        
        // S·ª≠ d·ª•ng toISOString() v√† thay th·∫ø 'Z' b·∫±ng '+00:00'
        return date.toISOString().replace('Z', '+00:00');
        
    } catch (error) {
        console.error('‚ùå L·ªói khi format th·ªùi gian:', error);
        return '';
    }
}
function populateHoaDonEdit(hoaDonData) {
    // TODO: Implement populate edit form
    console.log('Populate edit form:', hoaDonData);
    console.log(hoaDonData.PH.TenPhong);
    if (!hoaDonData) {
        console.error('‚ùå No data provided for edit');
        return;
    }
    resetHoaDonForm();
    
    // ƒêi·ªÅn d·ªØ li·ªáu v√†o form ch·ªânh s·ª≠a
    // V√≠ d·ª•:
    document.getElementById('hoaDonId').value = hoaDonData._id || '';
    document.getElementById('hoaDonMaHD').value = hoaDonData.MaHoaDon || '';
    document.getElementById('maKH').value = hoaDonData.KH.MaKH || '';
    document.getElementById('tenKH').value = hoaDonData.KH?.TenKH || '';
    document.getElementById('sdtKH').value = hoaDonData.KH?.SDT || '';
    document.getElementById('emailKH').value = hoaDonData.KH?.Email || '';
    thoiGianBatDauComeBack = formatToISODateTimeSimple(hoaDonData.ThoiGianBatDau);
    
    // ƒêi·ªÅn th√¥ng tin ph√≤ng - X·ª¨ L√ù TR∆Ø·ªúNG H·ª¢P PH√íNG KH√îNG C√ì TRONG SELECT
    if (hoaDonData.PH) {
        const phongSelect = document.getElementById('phongSelect');
        const maPhongValue = hoaDonData.PH.MaPhong;
        
        // Ki·ªÉm tra xem ph√≤ng c√≥ trong select ch∆∞a
        let optionExists = false;
        for (let i = 0; i < phongSelect.options.length; i++) {
            if (phongSelect.options[i].value === maPhongValue) {
                optionExists = true;
                break;
            }
        }
        
        // N·∫øu ch∆∞a c√≥, th√™m option m·ªõi
        if (!optionExists && hoaDonData.MaPhong) {
            const newOption = document.createElement('option');
            newOption.value = maPhongValue;
            newOption.textContent = `${hoaDonData.PH.TenPhong} (ƒêang s·ª≠ d·ª•ng)`;
            const giaPhong = calculateRoomPrice(hoaDonData.ThoiGianBatDau, hoaDonData.BangGia);
            console.log('GI√Å N√à: ', giaPhong);
            newOption.setAttribute('data-gia', giaPhong);
            phongSelect.appendChild(newOption);
        }
        
        // Set gi√° tr·ªã cho select
        phongSelect.value = maPhongValue;
        
        console.log('‚úÖ ƒê√£ set ph√≤ng:', maPhongValue);
    }
    
    // ƒêi·ªÅn th·ªùi gian
    if (hoaDonData.ThoiGianBatDau) {
        document.getElementById('thoiGianBatDau').value = formatDateTimeLocal(hoaDonData.ThoiGianBatDau);
    }

    console.log('CTHD', hoaDonData.ChiTietHoaDon);
    
    // ƒêi·ªÅn d·ªãch v·ª•
    if (hoaDonData.ChiTietHoaDon && Array.isArray(hoaDonData.ChiTietHoaDon)) {
        selectedServices = hoaDonData.ChiTietHoaDon.map(service => {
            console.log('Service item from API:', service);
            
            return {
                MaHang: service.MaHang, // ƒê√¢y l√† ID c·ªßa m·∫∑t h√†ng
                TenHang: service.MatHang?.TenHang || 'Unknown Item',
                SoLuong: service.SoLuong || 1,
                DonGia: service.MatHang?.DonGia || service.DonGia || 0,
                DonViTinh: service.MatHang?.DonViTinh || '',
                ThanhTien: service.ThanhTien || (service.SoLuong * (service.MatHang?.DonGia || service.DonGia)),
                SoLuongTon: service.MatHang?.SoLuongTon || 0,
                LoaiDichVu: service.LoaiDichVu || 'ƒê·ªì u·ªëng' // Th√™m LoaiDichVu t·ª´ API
            };
        });
        
        console.log('Processed services for form:', selectedServices);
        renderServicesList();
        calculateTotal();
    } else {
        console.warn('Kh√¥ng c√≥ chi ti·∫øt h√≥a ƒë∆°n ho·∫∑c d·ªØ li·ªáu kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng');
        selectedServices = [];
        renderServicesList();
    }
    // C·∫≠p nh·∫≠t UI ƒë·ªÉ hi·ªÉn th·ªã ƒëang edit mode
    document.getElementById('modalTitle').textContent = 'Ch·ªânh s·ª≠a h√≥a ƒë∆°n';
    setTimeout(() => {
        updateRoomPrice();
        calculateTotal();
    }, 200);
    
    // Debug: Ki·ªÉm tra gi√° tr·ªã ƒë√£ ƒë∆∞·ª£c set
    setTimeout(() => {
        console.log('Ph√≤ng select value:', document.getElementById('phongSelect').value);
        console.log('S·ªë l∆∞·ª£ng services:', selectedServices.length);
    }, 200);
}

// Delay sau 1 kho·∫£ng th·ªùi gian th√¨ m·ªõi th·ª±c thi h√†m
function debounce(func, delay) {
    let timerId
    return function () {
        clearTimeout(timerId)
        return timerId = setTimeout(() => {func.apply(this, arguments)}, delay)
    }
}

// Ki·ªÉm tra sƒët kh√°ch h√†ng tr∆∞·ªõc khi t·∫°o h√≥a ƒë∆°n m·ªõi
function checkExistPhoneCustomer(phone) {
    const phoneValue = document.querySelector('#sdtKH').value.trim()
    const fieldName = document.querySelector('#tenKH').closest('.form-group')
    const fieldEmail = document.querySelector('#emailKH').closest('.form-group')
    
    if(phoneValue.length < 10) {
        fieldName.classList.add('d-none')
        fieldEmail.classList.add('d-none')
        return
    }

    fieldName.classList.remove('d-none')
    fieldEmail.classList.remove('d-none')


    if(phoneValue.length === 10) {

        const getInforByPhone = async (phone) => {
            try {
                const res = await fetch(`/api/khachhang?phone=${phone}`)
                const khachHang = await res.json()
                const inputName = document.querySelector('#tenKH')
                const inputEmail = document.querySelector('#emailKH')

                if(khachHang && inputName && inputEmail) {
                    inputName.value = khachHang.TenKH
                    inputEmail.value = khachHang.Email
                }
                else{
                    inputName.value = ''
                    inputEmail.value = ''
                }
            } catch (error) {
                console.log({info: 'L·ªói khi l·∫•y th√¥ng tin kh√°ch h√†ng', message: error.message});
            }
        }

        const delay = 500

        const debouncedHandler = debounce(getInforByPhone, delay)
        debouncedHandler(phoneValue)
    }
}



// Export functions to global scope
window.updateServiceQuantity = updateServiceQuantity;
</script>

<style>
  /* ===== RESET & VARIABLES ===== */
:root {
  --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  --success-gradient: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  --warning-gradient: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
  --danger-gradient: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
  --info-gradient: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
  --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  --shadow-light: 0 4px 20px rgba(0, 0, 0, 0.08);
  --shadow-medium: 0 8px 30px rgba(0, 0, 0, 0.12);
  --shadow-heavy: 0 12px 40px rgba(0, 0, 0, 0.15);
  --border-radius: 12px;
  --border-radius-lg: 16px;
  --border-radius-xl: 20px;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

/* ===== LAYOUT CH√çNH ===== */
.main-content {
  margin-left: 280px;
  transition: margin-left 0.3s ease;
  min-height: 100vh;
  background: var(--bg-gradient);
}

.admin-dashboard {
  padding: 24px;
  min-height: 100vh;
}

/* ===== HEADER DASHBOARD ===== */
.dashboard-header {
  background: var(--primary-gradient);
  border-radius: var(--border-radius-lg);
  padding: 28px;
  margin-bottom: 28px;
  box-shadow: var(--shadow-light);
  color: white;
  position: relative;
  overflow: hidden;
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 20px;
  position: relative;
  z-index: 1;
}

.header-title {
  display: flex;
  align-items: center;
  gap: 20px;
}

.title-icon {
  font-size: 3rem;
  filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
}

.header-title h1 {
  margin: 0;
  font-size: 2rem;
  font-weight: 700;
}

.header-title p {
  margin: 8px 0 0 0;
  opacity: 0.9;
  font-size: 1.1rem;
}

/* ===== N√öT CHUNG ===== */
.btn-primary {
  background: var(--success-gradient);
  color: white;
  border: none;
  padding: 14px 24px;
  border-radius: var(--border-radius);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 600;
  font-size: 1rem;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(72, 187, 120, 0.4);
}

.btn-secondary {
  background: #f1f5f9;
  border: 2px solid #e2e8f0;
  color: #64748b;
  padding: 14px 24px;
  border-radius: var(--border-radius);
  cursor: pointer;
  display: flex;
  align-items: center;
  transition: all 0.3s ease;
  font-weight: 600;
}

.btn-secondary:hover {
  background: #e2e8f0;
  color: #475569;
}

.btn-edit,
.btn-delete {
  width: 56px;
  height: 56px;
  border: none;
  border-radius: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.btn-edit {
  background: var(--success-gradient);
  color: white;
}

.btn-delete {
  background: var(--danger-gradient);
  color: white;
}

/* ===== THANH T√åM KI·∫æM & B·ªò L·ªåC ===== */
.search-filter-bar {
  background: white;
  border-radius: var(--border-radius-lg);
  padding: 24px;
  margin-bottom: 28px;
  display: flex;
  gap: 24px;
  align-items: center;
  flex-wrap: wrap;
  box-shadow: var(--shadow-light);
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.search-box {
  display: flex;
  align-items: center;
  background: #f8fafc;
  border-radius: var(--border-radius);
  padding: 12px 20px;
  flex: 1;
  min-width: 320px;
  border: 2px solid #e2e8f0;
  transition: all 0.3s ease;
}

.search-box:focus-within {
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.search-box i {
  color: #64748b;
  margin-right: 12px;
  font-size: 1.1rem;
}

.search-box input {
  border: none;
  background: none;
  outline: none;
  flex: 1;
  padding: 8px 0;
  font-size: 1rem;
  color: #1e293b;
}

.search-btn {
  background: var(--primary-gradient);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 10px;
  cursor: pointer;
  margin-left: 16px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.filter-controls {
  display: flex;
  gap: 16px;
  align-items: center;
  flex-wrap: wrap;
}

.filter-select {
  padding: 12px 20px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  background: white;
  color: #475569;
  min-width: 180px;
  font-size: 1rem;
  transition: all 0.3s ease;
  cursor: pointer;
}

.clear-filters {
  background: #f1f5f9;
  border: 2px solid #e2e8f0;
  color: #64748b;
  padding: 12px 20px;
  border-radius: 10px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.3s ease;
  font-weight: 500;
}

/* ===== TH·ªêNG K√ä ===== */
.stats-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 24px;
  margin-bottom: 32px;
}

.stat-card {
  background: white;
  border-radius: var(--border-radius-xl);
  padding: 32px;
  display: flex;
  align-items: center;
  gap: 20px;
  box-shadow: var(--shadow-light);
  transition: all 0.3s ease;
  border: 1px solid rgba(0, 0, 0, 0.03);
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: var(--primary-gradient);
}

.stat-card:hover {
  transform: translateY(-5px);
  box-shadow: var(--shadow-medium);
}

.stat-icon {
  width: 80px;
  height: 80px;
  border-radius: var(--border-radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  box-shadow: var(--shadow-light);
}

.stat-icon.total { background: linear-gradient(135deg, #fed7d7, #feb2b2); color: #c53030; }
.stat-icon.active { background: linear-gradient(135deg, #c6f6d5, #9ae6b4); color: #276749; }
.stat-icon.reception { background: linear-gradient(135deg, #fed7d7, #feb2b2); color: #c53030; }
.stat-icon.service { background: linear-gradient(135deg, #fefcbf, #faf089); color: #d69e2e; }
.stat-icon.technical { background: linear-gradient(135deg, #e9d8fd, #d6bcfa); color: #6b46c1; }
.stat-icon.manager { background: linear-gradient(135deg, #c6f6d5, #9ae6b4); color: #276749; }
.stat-icon.security { background: linear-gradient(135deg, #fed7d7, #feb2b2); color: #c53030; }
.stat-icon.fulltime { background: linear-gradient(135deg, #bee3f8, #90cdf4); color: #2c5aa0; }

.stat-info h3 {
  margin: 0;
  font-size: 2.5rem;
  color: #1e293b;
  font-weight: 700;
}

.stat-info p {
  margin: 8px 0 0 0;
  color: #64748b;
  font-size: 1.1rem;
  font-weight: 500;
}

/* ===== L∆Ø·ªöI H√ìA ƒê∆†N ===== */
.employees-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
  gap: 28px;
}

.employee-card {
  background: white;
  border-radius: var(--border-radius-xl);
  overflow: hidden;
  box-shadow: var(--shadow-light);
  transition: all 0.4s ease;
  border: 1px solid rgba(0, 0, 0, 0.03);
  position: relative;
}

.employee-card:hover {
  transform: translateY(-8px);
  box-shadow: var(--shadow-heavy);
}

.employee-image {
  position: relative;
  height: 240px;
  overflow: hidden;
}

.employee-avatar-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
}

.employee-avatar-placeholder.bill {
  background: var(--primary-gradient);
}

.employee-avatar-placeholder.bill i {
  font-size: 2rem;
}

.employee-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: all 0.4s ease;
}

.employee-card:hover .employee-overlay {
  opacity: 1;
}

.employee-actions {
  display: flex;
  gap: 16px;
}

.employee-badge {
  position: absolute;
  top: 16px;
  left: 16px;
  padding: 8px 16px;
  border-radius: 25px;
  font-size: 0.85rem;
  font-weight: 700;
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow-light);
  z-index: 2;
}

.employee-badge.Ch∆∞a\ thanh\ to√°n {
  background: linear-gradient(135deg, rgba(237, 137, 54, 0.95), rgba(217, 119, 6, 0.95));
  color: white;
}

.employee-badge.ƒê√£\ thanh\ to√°n {
  background: linear-gradient(135deg, rgba(72, 187, 120, 0.95), rgba(56, 161, 105, 0.95));
  color: white;
}

.employee-badge.ƒê√£\ h·ªßy {
  background: linear-gradient(135deg, rgba(245, 101, 101, 0.95), rgba(229, 62, 62, 0.95));
  color: white;
}

.employee-status {
  position: absolute;
  bottom: 16px;
  right: 16px;
  padding: 8px 16px;
  border-radius: 25px;
  font-size: 0.9rem;
  font-weight: 700;
  box-shadow: var(--shadow-light);
  z-index: 2;
}

.employee-status.active {
  background: linear-gradient(135deg, rgba(72, 187, 120, 0.95), rgba(56, 161, 105, 0.95));
  color: white;
}

.employee-status.onleave {
  background: linear-gradient(135deg, rgba(237, 137, 54, 0.95), rgba(217, 119, 6, 0.95));
  color: white;
}

.employee-status.inactive {
  background: linear-gradient(135deg, rgba(245, 101, 101, 0.95), rgba(229, 62, 62, 0.95));
  color: white;
}

.employee-content {
  padding: 24px;
}

.employee-name {
  margin: 0 0 12px 0;
  color: #1e293b;
  font-size: 1.4rem;
  font-weight: 700;
}

.employee-code {
  margin: 0 0 20px 0;
  color: #64748b;
  font-size: 1rem;
  font-weight: 500;
}

.employee-details {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
}

.detail-item {
  display: flex;
  align-items: center;
  gap: 12px;
  color: #475569;
  font-size: 1rem;
}

.detail-item i {
  color: #667eea;
  width: 20px;
  font-size: 1.1rem;
}

/* ===== CHI TI·∫æT D·ªäCH V·ª§ TRONG CARD ===== */
.service-breakdown {
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #e2e8f0;
}

.service-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 5px;
  font-size: 0.9em;
}

.service-name {
  flex: 1;
}

.service-quantity {
  margin: 0 10px;
  color: #666;
}

.service-price {
  font-weight: bold;
  color: #2d3748;
}

/* ===== FOOTER CARD V·ªöI N√öT ===== */
.employee-footer {
  display: flex;
  gap: 10px;
  margin-top: 20px;
  padding-top: 15px;
  border-top: 1px solid #e2e8f0;
}

.employee-footer button {
  flex: 1;
  padding: 10px 15px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-weight: 600;
  font-size: 0.9rem;
  transition: all 0.3s ease;
}

.btn-detail {
  background: var(--info-gradient);
  color: white;
}

.btn-detail:hover {
  background: linear-gradient(135deg, #3182ce, #2c5aa0);
  transform: translateY(-2px);
}

.btn-pay {
  background: var(--success-gradient);
  color: white;
}

.btn-pay:hover {
  background: linear-gradient(135deg, #38a169, #2f855a);
  transform: translateY(-2px);
}

.btn-print {
  background: var(--warning-gradient);
  color: white;
}

.btn-print:hover {
  background: linear-gradient(135deg, #dd6b20, #c05621);
  transform: translateY(-2px);
}

/* ===== TR·∫†NG TH√ÅI R·ªñNG ===== */
.empty-state {
  text-align: center;
  padding: 80px 40px;
  background: white;
  border-radius: var(--border-radius-xl);
  box-shadow: var(--shadow-light);
  border: 2px dashed #e2e8f0;
}

.empty-icon {
  font-size: 5rem;
  margin-bottom: 24px;
  opacity: 0.7;
}

.empty-state h3 {
  margin: 0 0 12px 0;
  color: #1e293b;
  font-size: 1.8rem;
  font-weight: 700;
}

.empty-state p {
  margin: 0 0 32px 0;
  color: #64748b;
  font-size: 1.2rem;
}

/* ===== MODAL CHUNG ===== */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  padding: 20px;
  backdrop-filter: blur(8px);
}

.modal-container {
  background: white;
  border-radius: var(--border-radius-xl);
  width: 100%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
  border: 1px solid rgba(255, 255, 255, 0.2);
  animation: modalSlideIn 0.4s ease-out;
}

.modal-container.large {
  max-width: 800px;
}

.invoice-modal {
  max-width: 800px;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-30px) scale(0.9);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 28px;
  border-bottom: 2px solid #f1f5f9;
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
}

.modal-header h2 {
  margin: 0;
  color: #1e293b;
  font-size: 1.8rem;
  font-weight: 700;
}

.modal-close {
  background: #f1f5f9;
  border: none;
  font-size: 1.4rem;
  color: #64748b;
  cursor: pointer;
  padding: 8px;
  border-radius: var(--border-radius);
  transition: all 0.3s ease;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-body {
  padding: 28px;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 16px;
  padding: 28px;
  border-top: 2px solid #f1f5f9;
  background: #f8fafc;
  border-radius: 0 0 var(--border-radius-xl) var(--border-radius-xl);
}

/* ===== FORM TRONG MODAL ===== */
.form-section {
  margin-bottom: 30px;
  padding: 20px;
  background: #f8fafc;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
}

.form-section h3 {
  margin: 0 0 20px 0;
  color: #1e293b;
  font-size: 1.3rem;
  font-weight: 600;
  padding-bottom: 12px;
  border-bottom: 2px solid #e2e8f0;
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-group label {
  margin-bottom: 10px;
  color: #374151;
  font-weight: 600;
  font-size: 1rem;
}

.form-group input,
.form-group select,
.form-group textarea {
  padding: 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: var(--border-radius);
  font-size: 1rem;
  transition: all 0.3s ease;
  background: white;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  transform: translateY(-1px);
}

/* ===== PH·∫¶N D·ªäCH V·ª§ TRONG MODAL ===== */
.service-controls {
  display: grid;
  grid-template-columns: 1fr 0.85fr 90px auto;
  gap: 12px;
  align-items: end;
  margin-bottom: 20px;
}

.service-controls select,
.service-controls input {
  padding: 8px 12px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 1rem;
  transition: all 0.3s ease;
  background: white;
  height: 46px;
}

.service-controls select:focus,
.service-controls input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

#matHangSelect {
  width: 100%;
  min-height: 46px;
}

#soLuong {
  width: 100%;
  text-align: center;
  -moz-appearance: textfield;
}

#soLuong::-webkit-outer-spin-button,
#soLuong::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.service-controls button {
  height: 46px;
  padding: 12px 20px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  background: #f1f5f9;
  color: #64748b;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.service-controls button:hover {
  background: #e2e8f0;
  color: #475569;
  border-color: #cbd5e1;
}

.service-search {
  position: relative;
  display: flex;
  align-items: center;
}

.service-search input {
  width: 100%;
  padding: 12px 40px 12px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 8px;
  font-size: 1rem;
  height: 46px;
  transition: all 0.3s ease;
}

.service-search input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.service-search i {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: #64748b;
  pointer-events: none;
}

/* Services List */
.services-list-container {
  margin: 20px 0;
}

.services-list-container h4 {
  margin: 0 0 12px 0;
  color: #374151;
  font-size: 1.1rem;
  font-weight: 600;
}

.services-list {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  background: white;
}

.service-item-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid #f1f5f9;
  transition: all 0.3s ease;
}

.service-item-row:hover {
  background: #f8fafc;
}

.service-item-row:last-child {
  border-bottom: none;
}

.service-info {
  flex: 1;
}

.service-name {
  display: block;
  font-weight: 600;
  color: #1e293b;
  margin-bottom: 4px;
}

.service-details {
  font-size: 0.85rem;
  color: #64748b;
}

.service-quantity-controls {
  display: flex;
  align-items: center;
  gap: 8px;
  margin: 0 20px;
}

.qty-btn {
  width: 32px;
  height: 32px;
  border: 1px solid #d1d5db;
  background: white;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  transition: all 0.2s ease;
}

.qty-btn:hover {
  background: #f3f4f6;
  border-color: #9ca3af;
}

.service-quantity-controls input {
  width: 60px;
  text-align: center;
  padding: 6px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
}

.service-actions {
  display: flex;
  align-items: center;
  gap: 16px;
}

.service-total {
  font-weight: 600;
  color: #1e293b;
  min-width: 120px;
  text-align: right;
}

.no-services {
  text-align: center;
  padding: 40px 20px;
  color: #64748b;
  font-style: italic;
}

/* ===== T·ªîNG TI·ªÄN TRONG MODAL ===== */
.price-section {
  background: white;
  padding: 16px 20px;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
  margin-top: 15px;
}

.price-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 1.1rem;
}

.total-section {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white;
  padding: 20px;
  border-radius: 12px;
  margin-top: 20px;
}

.total-section .grand-total {
  font-size: 1.3rem;
}

/* ===== HEADER MODAL H√ìA ƒê∆†N HI·ªÜN ƒê·∫†I ===== */
.modal-header.invoice-company-header {
  background: var(--primary-gradient);
  color: white;
  padding: 25px 30px 20px;
  border-radius: var(--border-radius-xl) var(--border-radius-xl) 0 0;
  display: block;
}

.header-top-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.company-logo {
  display: flex;
  align-items: center;
  gap: 15px;
}

.logo-placeholder {
  width: 50px;
  height: 50px;
  background: rgba(255,255,255,0.2);
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
}

.company-info h1 {
  margin: 0 0 5px 0;
  font-size: 22px;
  font-weight: 700;
  line-height: 1.2;
}

.company-info p {
  margin: 0;
  font-size: 13px;
  opacity: 0.9;
  line-height: 1.3;
}

.header-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.btn-print-invoice,
.btn-download-invoice,
.btn-pay-invoice {
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.3s ease;
  background: rgba(255,255,255,0.2);
  color: white;
  backdrop-filter: blur(10px);
}

.btn-print-invoice:hover,
.btn-download-invoice:hover,
.btn-pay-invoice:hover {
  background: rgba(255,255,255,0.3);
  transform: translateY(-2px);
}

.btn-pay-invoice {
  background: var(--success-gradient);
}

.modal-close {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  font-size: 16px;
}

.modal-close:hover {
  background: rgba(255,255,255,0.3);
  transform: rotate(90deg);
}

.header-title-row {
  text-align: center;
  margin: 40px 0px 15px 0px;
}

.header-title-row h2 {
  margin: 0;
  font-size: 34px;
  font-weight: 700;
  color: white;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.header-meta-row {
  display: flex;
  justify-content: center;
  gap: 30px;
  flex-wrap: wrap;
}

.meta-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.meta-item .label {
  font-size: 13px;
  opacity: 0.8;
  margin-bottom: 4px;
  font-weight: 500;
}

.meta-item .value {
  font-size: 16px;
  font-weight: 600;
}

.status-badge {
  padding: 3px 6px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
}

.status-badge.paid {
  background: rgba(72, 187, 120, 0.9);
  color: white;
}

.status-badge.pending {
  background: rgba(237, 137, 54, 0.9);
  color: white;
}

.status-badge.cancelled {
  background: rgba(245, 101, 101, 0.9);
  color: white;
}

/* ===== H√ìA ƒê∆†N CHI TI·∫æT HI·ªÜN ƒê·∫†I ===== */
.modern-invoice {
  background: white;
  border-radius: 0 0 12px 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  overflow: hidden;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.invoice-customer-info {
  padding: 25px 30px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
  border-bottom: 1px solid #e2e8f0;
}

.info-section h3 {
  margin: 0 0 15px 0;
  color: #2d3748;
  font-size: 16px;
  font-weight: 600;
}

.info-grid {
  display: grid;
  gap: 10px;
}

.info-item {
  display: flex;
  justify-content: space-between;
}

.info-item .label {
  color: #718096;
  font-weight: 500;
}

.info-item .value {
  color: #2d3748;
  font-weight: 600;
}

.invoice-services {
  padding: 25px 30px;
  border-bottom: 1px solid #e2e8f0;
}

.invoice-services h3 {
  margin: 0 0 20px 0;
  color: #2d3748;
  font-size: 18px;
  font-weight: 600;
}

.services-table {
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  overflow: hidden;
}

.table-header {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr;
  background: #f7fafc;
  padding: 15px 20px;
  font-weight: 600;
  color: #4a5568;
  border-bottom: 1px solid #e2e8f0;
}

.table-row {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr;
  padding: 15px 20px;
  border-bottom: 1px solid #e2e8f0;
}

.table-row:last-child {
  border-bottom: none;
}

.table-row.no-services {
  grid-template-columns: 1fr;
  text-align: center;
  color: #718096;
  font-style: italic;
}

.col-service .service-name {
  display: block;
  font-weight: 500;
  color: #2d3748;
}

.col-service .service-desc {
  display: block;
  font-size: 12px;
  color: #718096;
  margin-top: 4px;
}

.col-quantity, .col-price, .col-total {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  font-weight: 500;
}

.invoice-summary {
  padding: 25px 30px;
  border-bottom: 1px solid #e2e8f0;
}

.summary-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
}

.summary-row.total {
  border-top: 2px solid #e2e8f0;
  margin-top: 10px;
  padding-top: 15px;
  font-size: 18px;
  font-weight: 700;
  color: #2d3748;
}

.invoice-payment {
  padding: 25px 30px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
  border-bottom: 1px solid #e2e8f0;
}

.payment-method h4, .payment-notes h4 {
  margin: 0 0 15px 0;
  color: #2d3748;
  font-size: 16px;
  font-weight: 600;
}

.method {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 15px;
  background: #f7fafc;
  border-radius: 8px;
  font-weight: 500;
}

.method.paid {
  color: #48bb78;
}

.method.cash {
  color: #ed8936;
}

.payment-notes p {
  margin: 5px 0;
  color: #718096;
  font-size: 14px;
}

.invoice-footer {
  padding: 25px 30px;
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
}

.footer-signature {
  text-align: center;
}

.signature-line {
  width: 200px;
  height: 1px;
  background: #2d3748;
  margin-bottom: 5px;
}

.footer-signature p {
  margin: 0;
  color: #718096;
  font-size: 14px;
}

.footer-thanks {
  text-align: right;
}

.footer-thanks p {
  margin: 2px 0;
  color: #4a5568;
}

/* ===== TR·∫†NG TH√ÅI LOADING V√Ä ERROR ===== */
.loading-invoice {
  text-align: center;
  padding: 60px 20px;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #667eea;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 20px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.error-state {
  text-align: center;
  padding: 60px 20px;
}

.error-icon {
  font-size: 48px;
  margin-bottom: 20px;
}

.error-state h3 {
  margin: 0 0 10px 0;
  color: #2d3748;
}

.error-state p {
  margin: 0 0 20px 0;
  color: #718096;
}

.highlight {
  color: #ff6b6b;
  font-weight: bold;
  text-shadow: 0 0 5px rgba(255, 107, 107, 0.5);
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .main-content {
    margin-left: 0 !important;
    padding: 16px;
  }

  .admin-dashboard {
    padding: 16px;
  }

  .header-content {
    flex-direction: column;
    align-items: stretch;
    text-align: center;
  }

  .header-title {
    justify-content: center;
    text-align: center;
  }

  .search-filter-bar {
    flex-direction: column;
    align-items: stretch;
    padding: 20px;
  }

  .search-box {
    min-width: auto;
    margin-bottom: 16px;
  }

  .filter-controls {
    flex-direction: column;
    align-items: stretch;
  }

  .filter-select {
    min-width: auto;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .employees-grid {
    grid-template-columns: 1fr;
    gap: 20px;
  }

  .stats-overview {
    grid-template-columns: 1fr;
    gap: 20px;
  }

  .modal-container {
    margin: 10px;
    max-width: none;
  }

  .employee-footer {
    flex-direction: column;
  }

  .invoice-customer-info,
  .invoice-payment {
    grid-template-columns: 1fr;
    gap: 20px;
  }

  .table-header,
  .table-row {
    grid-template-columns: 1fr;
    text-align: center;
    gap: 10px;
  }

  .col-quantity, .col-price, .col-total {
    justify-content: center;
  }

  .invoice-footer {
    flex-direction: column;
    gap: 20px;
    align-items: center;
  }

  .footer-signature,
  .footer-thanks {
    text-align: center;
  }

  .modal-header.invoice-company-header {
    padding: 20px 15px 15px;
  }

  .header-top-row {
    flex-direction: column;
    gap: 15px;
    margin-bottom: 15px;
  }

  .company-logo {
    flex-direction: column;
    text-align: center;
    gap: 10px;
  }

  .company-info h1 {
    font-size: 20px;
  }

  .company-info p {
    font-size: 12px;
  }

  .header-actions {
    width: 100%;
    justify-content: center;
  }

  .header-title-row h2 {
    font-size: 20px;
  }

  .header-meta-row {
    gap: 15px;
  }

  .meta-item .label {
    font-size: 12px;
  }

  .meta-item .value {
    font-size: 14px;
  }

  .btn-print-invoice,
  .btn-download-invoice,
  .btn-pay-invoice {
    padding: 8px 12px;
    font-size: 12px;
  }

  .service-controls {
    grid-template-columns: 1fr;
    gap: 12px;
  }
  
  .service-controls select,
  .service-controls input,
  .service-controls button {
    width: 100%;
  }
  
  .service-item-row {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }
  
  .service-quantity-controls {
    justify-content: center;
    margin: 0;
  }
  
  .service-actions {
    justify-content: space-between;
  }
}

@media (max-width: 1024px) {
  .service-controls {
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  
  .service-search {
    grid-column: 1 / -1;
  }
}

@media (max-width: 480px) {
  .header-meta-row {
    flex-direction: column;
    gap: 10px;
  }
  
  .meta-item {
    flex-direction: row;
    justify-content: space-between;
    width: 100%;
  }
  
  .meta-item .label {
    margin-bottom: 0;
  }

  .service-controls {
    gap: 8px;
  }
  
  .service-controls select,
  .service-controls input,
  .service-controls button {
    height: 44px;
    padding: 10px 14px;
    font-size: 0.95rem;
  }
}

/* ===== CSS CHO IN ·∫§N H√ìA ƒê∆†N ===== */
@media print {
  body { 
    margin: 0; 
    padding: 20px; 
    background: white !important;
  }
  
  .modern-invoice { 
    box-shadow: none; 
    border: 1px solid #ddd;
    padding: 20px;
    margin: 0;
  }
  
  .btn-print-invoice, 
  .btn-download-invoice, 
  .btn-pay-invoice,
  .modal-close,
  .modal-header .invoice-actions { 
    display: none !important; 
  }
  
  .modal-overlay {
    position: static;
    background: none;
    backdrop-filter: none;
  }
  
  .modal-container {
    box-shadow: none;
    max-width: none;
    max-height: none;
  }
}
/* Fix z-index cho SweetAlert2 */
.swal2-container {
  z-index: 99999 !important;
}

/* ƒê·∫£m b·∫£o modal backdrop c·ªßa SweetAlert2 c≈©ng c√≥ z-index cao */
.swal2-backdrop-show {
  z-index: 99998 !important;
}
/* ===== CSS CHO HEADER MODAL M·ªöI ===== */
  .modal-header.invoice-company-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px 30px 20px;
    border-radius: 24px 24px 0 0;
  }

  /* H√†ng 1: Logo v√† n√∫t h√†nh ƒë·ªông */
  .header-top-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }

  .company-logo {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .logo-placeholder {
    width: 50px;
    height: 50px;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
  }

  .company-info h1 {
    margin: 0 0 5px 0;
    font-size: 22px;
    font-weight: 700;
    line-height: 1.2;
  }

  .company-info p {
    margin: 0;
    font-size: 13px;
    opacity: 0.9;
    line-height: 1.3;
  }

  .header-actions {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .btn-print-invoice,
  .btn-download-invoice,
  .btn-pay-invoice {
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
    background: rgba(255,255,255,0.2);
    color: white;
    backdrop-filter: blur(10px);
  }

  .btn-print-invoice:hover,
  .btn-download-invoice:hover,
  .btn-pay-invoice:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-2px);
  }

  .btn-pay-invoice {
    background: linear-gradient(135deg, #48bb78, #38a169);
  }

  .modal-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    font-size: 16px;
  }

  .modal-close:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg);
  }

  /* H√†ng 2: Ti√™u ƒë·ªÅ */
  .header-title-row {
    text-align: center;
    margin-bottom: 15px;
  }

  .header-title-row h2 {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
    color: white;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  /* H√†ng 3: Th√¥ng tin h√≥a ƒë∆°n */
  .header-meta-row {
    display: flex;
    justify-content: center;
    gap: 30px;
    flex-wrap: wrap;
  }

  .meta-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }

  .meta-item .label {
    font-size: 13px;
    opacity: 0.8;
    margin-bottom: 4px;
    font-weight: 500;
  }

  .meta-item .value {
    font-size: 16px;
    font-weight: 600;
  }

  .status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
  }

  .status-badge.paid {
    background: rgba(72, 187, 120, 0.9);
    color: white;
  }

  .status-badge.pending {
    background: rgba(237, 137, 54, 0.9);
    color: white;
  }

  .status-badge.cancelled {
    background: rgba(245, 101, 101, 0.9);
    color: white;
  }

  /* ===== ƒêI·ªÄU CH·ªàNH L·∫†I MODAL CHO HEADER M·ªöI ===== */
  .invoice-modal {
    max-width: 800px;
  }

  .invoice-modal .modal-body {
    padding: 0;
  }

  .modern-invoice {
    border-radius: 0 0 12px 12px;
  }

  /* ===== RESPONSIVE CHO HEADER M·ªöI ===== */
  @media (max-width: 768px) {
    .modal-header.invoice-company-header {
      padding: 20px 15px 15px;
    }

    .header-top-row {
      flex-direction: column;
      gap: 15px;
      margin-bottom: 15px;
    }

    .company-logo {
      flex-direction: column;
      text-align: center;
      gap: 10px;
    }

    .company-info h1 {
      font-size: 20px;
    }

    .company-info p {
      font-size: 12px;
    }

    .header-actions {
      width: 100%;
      justify-content: center;
    }

    .header-title-row h2 {
      font-size: 20px;
    }

    .header-meta-row {
      gap: 15px;
    }

    .meta-item .label {
      font-size: 12px;
    }

    .meta-item .value {
      font-size: 14px;
    }

    .btn-print-invoice,
    .btn-download-invoice,
    .btn-pay-invoice {
      padding: 8px 12px;
      font-size: 12px;
    }
  }

  @media (max-width: 480px) {
    .header-meta-row {
      flex-direction: column;
      gap: 10px;
    }
    
    .meta-item {
      flex-direction: row;
      justify-content: space-between;
      width: 100%;
    }
    
    .meta-item .label {
      margin-bottom: 0;
    }
  }
/* Hi·ªáu ·ª©ng cho card khi b·ªã x√≥a */
.employee-card {
    transition: all 0.3s ease;
}

/* Tr·∫°ng th√°i khi ƒëang x√≥a */
.employee-card.deleting {
    opacity: 0.5;
    transform: scale(0.95);
    background-color: #ffeef0;
}

/* N√∫t x√≥a v·ªõi hi·ªáu ·ª©ng hover */
.btn-delete {
    transition: all 0.2s ease;
}

.btn-delete:hover {
    background-color: #e74c3c;
    transform: scale(1.1);
}
</style>